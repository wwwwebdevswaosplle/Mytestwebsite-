<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CMC Admin Panel</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* (keep all existing styles ‚Äì same as before) */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Inter',sans-serif; }
        body { min-height:100vh; background-image:url('https://i.ibb.co/sdj8WfWJ/cheerful-3d-alien-world-1.jpg'); background-size:cover; background-position:center; background-attachment:fixed; color:#fff; display:flex; align-items:center; justify-content:center; padding:0; }
        #authContainer { background:rgba(31,44,52,0.95); backdrop-filter:blur(10px); border-radius:24px; padding:30px 24px; max-width:400px; width:100%; box-shadow:0 20px 40px rgba(0,0,0,0.5); border:1px solid #8e44ad; text-align:center; }
        .auth-logo { width:80px; height:80px; border-radius:50%; margin-bottom:20px; border:3px solid #8e44ad; object-fit:cover; }
        input, select, textarea { width:100%; padding:14px 16px; margin:8px 0; border:none; border-radius:24px; background:#2a3942; color:white; font-size:16px; }
        button { width:100%; padding:14px; margin:8px 0; border:none; border-radius:24px; background:#8e44ad; color:white; font-size:16px; font-weight:600; cursor:pointer; }
        button.small { width:auto; padding:8px 12px; margin:4px; font-size:0.8rem; }
        button.danger { background:#e74c3c; }
        button.warning { background:#f39c12; }
        #dashboard { display:none; width:100%; height:100vh; max-width:600px; margin:0 auto; background:transparent; flex-direction:column; position:relative; }
        .header { display:flex; justify-content:space-between; align-items:center; background:rgba(31,44,52,0.9); backdrop-filter:blur(10px); padding:15px 20px; border-bottom:1px solid #8e44ad; position:sticky; top:0; z-index:100; }
        .header h1 { font-size:1.3rem; display:flex; align-items:center; gap:10px; }
        .header button { width:auto; padding:8px 16px; margin:0; }
        .notification-bells { display:flex; justify-content:space-around; background:rgba(31,44,52,0.9); backdrop-filter:blur(10px); padding:10px 0; border-bottom:1px solid #8e44ad; position:sticky; top:70px; z-index:99; }
        .bell-item { position:relative; cursor:pointer; text-align:center; padding:5px 10px; border-radius:20px; transition:background 0.2s; }
        .bell-item:hover { background:rgba(142,68,173,0.3); }
        .bell-item.active { background:rgba(142,68,173,0.5); }
        .bell-item i { font-size:1.5rem; color:#8e44ad; }
        .bell-badge { position:absolute; top:-5px; right:-5px; background:#ff4d4d; color:white; border-radius:50%; min-width:20px; height:20px; font-size:0.7rem; display:flex; align-items:center; justify-content:center; font-weight:bold; border:2px solid #1f2c34; }
        .bell-label { font-size:0.7rem; margin-top:2px; color:#aaa; }
        .bottom-nav { display:flex; justify-content:space-around; background:rgba(31,44,52,0.95); backdrop-filter:blur(10px); padding:8px 0; border-top:1px solid #8e44ad; position:fixed; bottom:0; width:100%; max-width:600px; z-index:100; }
        .nav-item { display:flex; flex-direction:column; align-items:center; color:#8696a0; font-size:12px; cursor:pointer; padding:4px 0; flex:1; }
        .nav-item.active { color:#8e44ad; }
        .nav-item i { font-size:1.4rem; margin-bottom:2px; }
        .pages { flex:1; overflow-y:auto; padding:16px 16px 80px 16px; -webkit-overflow-scrolling:touch; }
        .page { display:none; }
        .page.active { display:block; }
        .section { background:rgba(31,44,52,0.9); backdrop-filter:blur(10px); border-radius:20px; padding:16px; margin-bottom:16px; border:1px solid #8e44ad; }
        .section h2 { margin-bottom:12px; display:flex; align-items:center; gap:8px; color:#8e44ad; font-size:1.2rem; }
        .grid { display:grid; grid-template-columns:1fr; gap:12px; }
        .card { background:#2a3942; border-radius:16px; padding:12px; position:relative; transition:0.2s; border:1px solid transparent; }
        .card:hover { border-color:#8e44ad; }
        .card.blocked { opacity:0.6; background:#3a3a3a; }
        .card .actions { display:flex; gap:6px; margin-top:8px; flex-wrap:wrap; }
        .badge { background:#8e44ad; color:white; padding:2px 6px; border-radius:10px; font-size:0.7rem; display:inline-block; margin-left:5px; }
        .stats { display:flex; gap:10px; flex-wrap:wrap; }
        .stat-card { background:#2a3942; border-radius:16px; padding:16px; flex:1 1 calc(50% - 10px); min-width:120px; text-align:center; }
        .stat-card .number { font-size:2rem; font-weight:800; color:#8e44ad; }
        .celeb-group { margin-bottom:20px; }
        .celeb-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer; padding:8px; background:rgba(142,68,173,0.2); border-radius:30px; }
        .celeb-header img { width:40px; height:40px; border-radius:50%; object-fit:cover; }
        .celeb-header span { font-weight:600; flex:1; }
        .celeb-header i { transition:transform 0.2s; }
        .celeb-header.collapsed i { transform:rotate(-90deg); }
        .user-conversations { padding-left:10px; }
        .fan-card { display:flex; align-items:center; gap:12px; background:#2a3942; border-radius:16px; padding:12px; margin-bottom:8px; }
        .fan-card img { width:48px; height:48px; border-radius:50%; object-fit:cover; }
        .fan-info { flex:1; }
        .fan-info .name { font-weight:600; }
        .fan-info .last-msg { font-size:0.8rem; color:#aaa; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px; }
        .fan-info .time { font-size:0.7rem; color:#666; }
        .chat-button { background:#8e44ad; border:none; color:white; padding:8px 12px; border-radius:20px; font-size:0.8rem; cursor:pointer; }
        #chatWindow { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; display:none; flex-direction:column; }
        .chat-header { display:flex; align-items:center; padding:15px; background:#1f2c34; border-bottom:1px solid #8e44ad; }
        .chat-header i { font-size:1.5rem; cursor:pointer; margin-right:15px; }
        .chat-header img { width:40px; height:40px; border-radius:50%; margin-right:10px; object-fit:cover; }
        .chat-header span { flex:1; font-weight:600; }
        .chat-messages { flex:1; padding:15px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
        .chat-message { max-width:80%; padding:10px 15px; border-radius:18px; font-size:0.95rem; word-wrap:break-word; }
        .chat-message.sent { align-self:flex-end; background:#8e44ad; color:white; border-bottom-right-radius:4px; }
        .chat-message.received { align-self:flex-start; background:#2a3942; color:white; border-bottom-left-radius:4px; }
        .chat-input-area { display:flex; padding:15px; background:#1f2c34; gap:10px; border-top:1px solid #8e44ad; }
        .chat-input { flex:1; background:#2a3942; border:none; padding:12px; border-radius:25px; color:white; }
        .send-btn { width:40px; height:40px; border-radius:50%; background:#8e44ad; color:white; border:none; cursor:pointer; }
        .input-box { background:#2a3942; border:1px solid #8e44ad; color:white; }
        .filter-buttons { display:flex; gap:8px; margin-bottom:15px; flex-wrap:wrap; }
        .filter-btn { background:#2a3942; border:1px solid #8e44ad; color:white; padding:6px 12px; border-radius:20px; font-size:0.8rem; cursor:pointer; }
        .filter-btn.active { background:#8e44ad; }
        .notification-entry { background:#2a3942; border-radius:12px; padding:10px; margin-bottom:8px; border-left:4px solid #8e44ad; }
        .notification-entry.unread { border-left-color:#ff4d4d; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authContainer">
        <img src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" class="auth-logo">
        <h2 style="margin-bottom:20px;">Admin Login</h2>
        <div id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email" value="moxxxtiox@gmail.com">
            <input type="password" id="loginPassword" placeholder="Password">
            <button onclick="loginUser()">Log In</button>
        </div>
        <div id="message" style="color:#ff6b6b; margin-top:10px;"></div>
    </div>

    <!-- Admin Dashboard -->
    <div id="dashboard">
        <div class="header">
            <h1><i class="fas fa-crown" style="color:#8e44ad;"></i> CMC Admin</h1>
            <button onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>

        <!-- 4 Notification Bells -->
        <div class="notification-bells">
            <div class="bell-item" id="bellSupport" onclick="filterNotifications('support')">
                <i class="fas fa-headset"></i>
                <span class="bell-badge" id="badgeSupport">0</span>
                <div class="bell-label">Support</div>
            </div>
            <div class="bell-item" id="bellCelebrity" onclick="filterNotifications('celebrity')">
                <i class="fas fa-star"></i>
                <span class="bell-badge" id="badgeCelebrity">0</span>
                <div class="bell-label">Celebrities</div>
            </div>
            <div class="bell-item" id="bellActivity" onclick="filterNotifications('activity')">
                <i class="fas fa-exchange-alt"></i>
                <span class="bell-badge" id="badgeActivity">0</span>
                <div class="bell-label">Activities</div>
            </div>
            <div class="bell-item" id="bellPosts" onclick="filterNotifications('posts')">
                <i class="fas fa-newspaper"></i>
                <span class="bell-badge" id="badgePosts">0</span>
                <div class="bell-label">Posts</div>
            </div>
        </div>

        <!-- Filter container -->
        <div id="filterContainer" style="display: none; padding: 10px 16px; background: rgba(31,44,52,0.9);">
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="setNotificationFilter('all')">All</button>
                <button class="filter-btn" onclick="setNotificationFilter('support')">Support</button>
                <button class="filter-btn" onclick="setNotificationFilter('celebrity')">Celebrity</button>
                <button class="filter-btn" onclick="setNotificationFilter('activity')">Activity</button>
                <button class="filter-btn" onclick="setNotificationFilter('posts')">Posts</button>
            </div>
            <div id="notificationsList"></div>
        </div>

        <!-- Pages -->
        <div class="pages">
            <div id="pageDashboard" class="page active">
                <div class="section">
                    <h2><i class="fas fa-tachometer-alt"></i> Overview</h2>
                    <div class="stats">
                        <div class="stat-card"><span class="number" id="statUsers">0</span><br>Users</div>
                        <div class="stat-card"><span class="number" id="statPosts">0</span><br>Posts</div>
                        <div class="stat-card"><span class="number" id="statCelebs">0</span><br>Celebrities</div>
                        <div class="stat-card"><span class="number" id="statProducts">0</span><br>Products</div>
                    </div>
                </div>
                <div class="section">
                    <h2><i class="fas fa-info-circle"></i> Quick Actions</h2>
                    <p>Use the bottom navigation to manage users, posts, celebrities, products, fan chats, and settings.</p>
                </div>
            </div>

            <div id="pageUsers" class="page">
                <div class="section">
                    <h2><i class="fas fa-users"></i> Users</h2>
                    <input type="text" id="searchUsers" placeholder="Search by name or email..." class="input-box" style="margin-bottom:15px;">
                    <div id="usersList" class="grid"></div>
                </div>
            </div>

            <div id="pagePosts" class="page">
                <div class="section">
                    <h2><i class="fas fa-newspaper"></i> Posts</h2>
                    <div id="postsList" class="grid"></div>
                </div>
            </div>

            <div id="pageCelebs" class="page">
                <div class="section">
                    <h2><i class="fas fa-star"></i> Celebrities</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="celebName" placeholder="Celebrity Name" class="input-box">
                        <input type="url" id="celebImg" placeholder="Image URL" class="input-box">
                        <button onclick="addCelebrity()" style="width:auto;">Add</button>
                    </div>
                    <div id="celebsList" class="grid"></div>
                </div>
            </div>

            <div id="pageProducts" class="page">
                <div class="section">
                    <h2><i class="fas fa-shopping-cart"></i> Products</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <input type="text" id="productName" placeholder="Product Name" class="input-box">
                        <input type="number" id="productPrice" placeholder="Price" class="input-box">
                        <input type="text" id="productIcon" placeholder="Icon (e.g., 'box')" class="input-box" value="box">
                        <button onclick="addProduct()" style="width:auto;">Add</button>
                    </div>
                    <div id="productsList" class="grid"></div>
                </div>
            </div>

            <div id="pageFanChats" class="page">
                <div class="section">
                    <h2><i class="fas fa-heart"></i> Fan Conversations</h2>
                    <div id="fanChatsContainer"></div>
                </div>
            </div>

            <div id="pageSettings" class="page">
                <div class="section">
                    <h2><i class="fas fa-bullhorn"></i> Notifications</h2>
                    <select id="notifyTarget" class="input-box">
                        <option value="all">All Users</option>
                        <option value="user">Specific User</option>
                    </select>
                    <input type="text" id="notifyUserId" class="input-box" placeholder="User ID (if specific)" style="display:none;">
                    <input type="text" id="notifyTitle" class="input-box" placeholder="Title">
                    <textarea id="notifyMessage" class="input-box" placeholder="Message"></textarea>
                    <input type="text" id="notifyLink" class="input-box" placeholder="Link (optional)">
                    <button onclick="sendNotification()">Send Notification</button>
                </div>
                <div class="section">
                    <h2><i class="fas fa-music"></i> Global Music</h2>
                    <div style="display: flex; gap: 10px;">
                        <input type="url" id="musicUrl" class="input-box" placeholder="Music URL (mp3)">
                        <button onclick="setMusicUrl()" style="width:auto;">Set</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i><span>Home</span></div>
            <div class="nav-item" data-page="users"><i class="fas fa-users"></i><span>Users</span></div>
            <div class="nav-item" data-page="posts"><i class="fas fa-newspaper"></i><span>Posts</span></div>
            <div class="nav-item" data-page="celebs"><i class="fas fa-star"></i><span>Celebs</span></div>
            <div class="nav-item" data-page="products"><i class="fas fa-shopping-cart"></i><span>Shop</span></div>
            <div class="nav-item" data-page="fanChats"><i class="fas fa-heart"></i><span>Fans</span></div>
            <div class="nav-item" data-page="settings"><i class="fas fa-cog"></i><span>Settings</span></div>
        </div>
    </div>

    <!-- Full-screen Chat Window -->
    <div id="chatWindow">
        <div class="chat-header">
            <i class="fas fa-arrow-left" onclick="closeChatWindow()"></i>
            <img id="chatAvatar" src="" alt="avatar">
            <span id="chatTitle">Chat</span>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" class="chat-input" placeholder="Type message...">
            <button class="send-btn" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        // ========== FIREBASE ==========
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, updateDoc, onSnapshot, orderBy, serverTimestamp, addDoc, increment, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
        import Toastify from 'https://cdn.jsdelivr.net/npm/toastify-js/src/toastify-es.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDvSEbNwMZJeE7WXrUvjclmSpeDyTjqLzw",
            authDomain: "fully-understand.firebaseapp.com",
            projectId: "fully-understand",
            storageBucket: "fully-understand.firebasestorage.app",
            messagingSenderId: "372305817292",
            appId: "1:372305817292:web:795d8def6932874df09c69"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const defaultAvatar = 'https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png';
        const ADMIN_EMAIL = "moxxxtiox@gmail.com";

        // Global variables
        let currentChatUserId = null;
        let currentChatCeleb = null;
        let currentChatUserData = null;
        let chatUnsubscribe = null;
        let users = [], posts = [], celebs = [], products = [], fanMessages = [], orders = [], withdrawals = [];
        let currentNotificationFilter = 'all';

        // ========== LOGIN ==========
        window.loginUser = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            if (!email || !pass) return Toastify({ text: "Enter email and password" }).showToast();
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                Toastify({ text: e.message, backgroundColor: "#e74c3c" }).showToast();
            }
        };

        window.logout = () => signOut(auth);

        // ========== AUTH STATE ==========
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Logged in as:", user.email);
                if (user.email === ADMIN_EMAIL) {
                    console.log("Admin detected");
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'flex';
                    loadDashboard();
                } else {
                    alert("You are not an admin.");
                    signOut(auth);
                    document.getElementById('authContainer').style.display = 'block';
                    document.getElementById('dashboard').style.display = 'none';
                }
            } else {
                document.getElementById('authContainer').style.display = 'block';
                document.getElementById('dashboard').style.display = 'none';
            }
        });

        // ========== BOTTOM NAVIGATION ==========
        const navItems = document.querySelectorAll('.nav-item');
        const pages = {
            dashboard: document.getElementById('pageDashboard'),
            users: document.getElementById('pageUsers'),
            posts: document.getElementById('pagePosts'),
            celebs: document.getElementById('pageCelebs'),
            products: document.getElementById('pageProducts'),
            fanChats: document.getElementById('pageFanChats'),
            settings: document.getElementById('pageSettings')
        };

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const page = item.dataset.page;
                navItems.forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                Object.values(pages).forEach(p => p.classList.remove('active'));
                pages[page].classList.add('active');
                // Hide notification filter when changing pages
                document.getElementById('filterContainer').style.display = 'none';
            });
        });

        // ========== NOTIFICATION FILTERING ==========
        window.filterNotifications = (type) => {
            currentNotificationFilter = type;
            document.getElementById('filterContainer').style.display = 'block';
            updateNotificationsList();
        };

        window.setNotificationFilter = (type) => {
            currentNotificationFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateNotificationsList();
        };

        function updateNotificationsList() {
            const list = document.getElementById('notificationsList');
            let filtered = [];

            const supportChats = fanMessages.filter(m => m.celebrity === 'Support' || m.celebrity === 'Admin');
            const celebrityMessages = fanMessages.filter(m => m.celebrity && m.celebrity !== 'Support' && m.celebrity !== 'Admin');
            const activities = [...orders, ...withdrawals];
            const allPosts = posts;

            if (currentNotificationFilter === 'all') {
                filtered = [
                    ...supportChats.map(m => ({ type: 'support', data: m })),
                    ...celebrityMessages.map(m => ({ type: 'celebrity', data: m })),
                    ...activities.map(a => ({ type: 'activity', data: a })),
                    ...allPosts.map(p => ({ type: 'posts', data: p }))
                ].sort((a, b) => {
                    const timeA = a.data.timestamp?.toDate?.() || new Date(a.data.createdAt || 0);
                    const timeB = b.data.timestamp?.toDate?.() || new Date(b.data.createdAt || 0);
                    return timeB - timeA;
                });
            } else if (currentNotificationFilter === 'support') {
                filtered = supportChats.map(m => ({ type: 'support', data: m }));
            } else if (currentNotificationFilter === 'celebrity') {
                filtered = celebrityMessages.map(m => ({ type: 'celebrity', data: m }));
            } else if (currentNotificationFilter === 'activity') {
                filtered = activities.map(a => ({ type: 'activity', data: a }));
            } else if (currentNotificationFilter === 'posts') {
                filtered = allPosts.map(p => ({ type: 'posts', data: p }));
            }

            list.innerHTML = filtered.map(item => {
                const d = item.data;
                if (item.type === 'support') {
                    return `<div class="notification-entry">üí¨ Support chat with ${d.userName}: ${d.message}</div>`;
                } else if (item.type === 'celebrity') {
                    return `<div class="notification-entry">‚≠ê ${d.userName} to ${d.celebrity}: ${d.message}</div>`;
                } else if (item.type === 'activity') {
                    if (d.product) {
                        return `<div class="notification-entry">üí∞ Purchase: ${d.product} by ${d.userId}</div>`;
                    } else {
                        return `<div class="notification-entry">üí∏ Withdrawal: $${d.amount} by ${d.userId}</div>`;
                    }
                } else if (item.type === 'posts') {
                    return `<div class="notification-entry">üìù New post by ${d.userName}: ${d.caption?.substring(0,30)}...</div>`;
                }
                return '';
            }).join('');
        }

        // Update bell badges
        function updateBellBadges() {
            document.getElementById('badgeSupport').textContent = fanMessages.filter(m => m.celebrity === 'Support' || m.celebrity === 'Admin').length;
            document.getElementById('badgeCelebrity').textContent = fanMessages.filter(m => m.celebrity && m.celebrity !== 'Support' && m.celebrity !== 'Admin').length;
            document.getElementById('badgeActivity').textContent = orders.length + withdrawals.length;
            document.getElementById('badgePosts').textContent = posts.length;
        }

        // ========== DASHBOARD DATA ==========
        function loadDashboard() {
            // Users
            const usersQuery = query(collection(db, 'users'));
            onSnapshot(usersQuery, (snap) => {
                users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statUsers').innerText = users.length;
                filterUsers();
                updateBellBadges();
            });

            // Posts
            const postsQuery = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
            onSnapshot(postsQuery, (snap) => {
                posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statPosts').innerText = posts.length;
                renderPosts();
                updateBellBadges();
                updateNotificationsList();
            });

            // Celebrities
            const celebsQuery = query(collection(db, 'celebrities'));
            onSnapshot(celebsQuery, (snap) => {
                celebs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statCelebs').innerText = celebs.length;
                renderCelebs();
            });

            // Products
            const productsQuery = query(collection(db, 'products'));
            onSnapshot(productsQuery, (snap) => {
                products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statProducts').innerText = products.length;
                renderProducts();
            });

            // Fan messages (adminMessages)
            const fanQuery = query(collection(db, 'adminMessages'), orderBy('timestamp', 'desc'));
            onSnapshot(fanQuery, (snap) => {
                fanMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFanChats();
                updateBellBadges();
                updateNotificationsList();
            });

            // Orders (for activities)
            const ordersQuery = query(collection(db, 'orders'), orderBy('timestamp', 'desc'));
            onSnapshot(ordersQuery, (snap) => {
                orders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateBellBadges();
                updateNotificationsList();
            });

            // Withdrawals
            const withdrawalsQuery = query(collection(db, 'withdrawals'), orderBy('timestamp', 'desc'));
            onSnapshot(withdrawalsQuery, (snap) => {
                withdrawals = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateBellBadges();
                updateNotificationsList();
            });

            // Music URL
            getDoc(doc(db, 'settings', 'music')).then((docSnap) => {
                if (docSnap.exists()) {
                    document.getElementById('musicUrl').value = docSnap.data().url || '';
                }
            });
        }

        // ========== FAN CHATS (FIXED: uses private chat ID) ==========
        function renderFanChats() {
            const container = document.getElementById('fanChatsContainer');
            if (!container) return;

            // Group by celebrity and user (private chats)
            const chatMap = new Map(); // key = celebrityName_userId

            fanMessages.forEach(msg => {
                const celebName = msg.celebrity;
                const userId = msg.userId;
                const key = `${celebName}_${userId}`;
                const userName = msg.userName || 'Unknown';
                const userAvatar = msg.userAvatar || defaultAvatar;
                const text = msg.message;
                const time = msg.timestamp?.toDate?.() || new Date();
                const fromAdmin = msg.fromAdmin || false;
                // Use the stored chatId if available, otherwise construct it
                const chatId = msg.chatId || `celeb_${celebName.replace(/[^a-zA-Z0-9]/g, '_')}_${userId}`;

                if (!chatMap.has(key)) {
                    const celeb = celebs.find(c => c.name === celebName);
                    chatMap.set(key, {
                        celebName,
                        celebAvatar: celeb ? celeb.img : defaultAvatar,
                        userId,
                        userName,
                        userAvatar,
                        vip: users.find(u => u.id === userId)?.vipLevel || 1,
                        lastMessage: text,
                        lastTime: time,
                        fromAdmin,
                        chatId,
                        unread: !msg.read
                    });
                } else {
                    const existing = chatMap.get(key);
                    if (time > existing.lastTime) {
                        existing.lastMessage = text;
                        existing.lastTime = time;
                        existing.fromAdmin = fromAdmin;
                        if (!msg.read) existing.unread = true;
                    }
                }
            });

            // Group by celebrity for display
            const celebGroups = new Map();
            for (let [key, chat] of chatMap.entries()) {
                if (!celebGroups.has(chat.celebName)) {
                    celebGroups.set(chat.celebName, {
                        avatar: chat.celebAvatar,
                        chats: []
                    });
                }
                celebGroups.get(chat.celebName).chats.push(chat);
            }

            let html = '';
            for (let [celebName, group] of celebGroups.entries()) {
                group.chats.sort((a,b) => b.lastTime - a.lastTime);
                html += `
                    <div class="celeb-group">
                        <div class="celeb-header" onclick="toggleCelebGroup(this)">
                            <img src="${group.avatar}" onerror="this.src='${defaultAvatar}'">
                            <span>${celebName} (${group.chats.length})</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="user-conversations">
                `;
                group.chats.forEach(chat => {
                    const timeStr = formatTimeAgo(chat.lastTime);
                    html += `
                        <div class="fan-card ${chat.unread ? 'unread' : ''}">
                            <img src="${chat.userAvatar}" onerror="this.src='${defaultAvatar}'">
                            <div class="fan-info">
                                <div class="name">${chat.userName} <span class="badge">VIP ${chat.vip}</span></div>
                                <div class="last-msg">${chat.fromAdmin ? 'üëë You: ' : ''}${chat.lastMessage}</div>
                                <div class="time">${timeStr}</div>
                            </div>
                            <button class="chat-button" onclick="openFanChat('${chat.celebName}', '${chat.celebAvatar}', '${chat.userId}', '${chat.userName}', '${chat.userAvatar}', '${chat.chatId}')">Chat</button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            if (html === '') {
                html = '<p style="color:#aaa; text-align:center;">No fan conversations yet.</p>';
            }
            container.innerHTML = html;
        }

        window.toggleCelebGroup = (header) => {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        };

        function formatTimeAgo(date) {
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        // ========== OPEN CHAT (FIXED: uses private chat ID) ==========
        window.openFanChat = (celebName, celebAvatar, userId, userName, userAvatar, chatId) => {
            console.log('Opening fan chat with ID:', chatId);
            currentChatUserId = userId;
            currentChatCeleb = { name: celebName, avatar: celebAvatar };
            currentChatUserData = { name: userName, avatar: userAvatar };
            document.getElementById('chatTitle').innerText = `Chat with ${userName} (as ${celebName})`;
            document.getElementById('chatAvatar').src = userAvatar;
            document.getElementById('chatWindow').style.display = 'flex';
            loadChatMessages(chatId);
        };

        function loadChatMessages(chatId) {
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            if (chatUnsubscribe) chatUnsubscribe();
            chatUnsubscribe = onSnapshot(query(messagesRef, orderBy('timestamp')), (snap) => {
                console.log('Chat messages loaded for', chatId, 'count:', snap.size);
                const container = document.getElementById('chatMessages');
                container.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const isSent = m.sender === auth.currentUser.uid;
                    return `<div class="chat-message ${isSent ? 'sent' : 'received'}">${m.text}</div>`;
                }).join('');
                container.scrollTop = container.scrollHeight;
            }, (error) => {
                console.error('Error loading chat messages:', error);
            });
        }

        // ========== SEND CHAT MESSAGE (FIXED: uses private chat ID) ==========
        window.sendChatMessage = async () => {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text || !currentChatUserId || !currentChatCeleb) return;
            
            const chatId = `celeb_${currentChatCeleb.name.replace(/[^a-zA-Z0-9]/g, '_')}_${currentChatUserId}`;
            console.log('Sending message to chat ID:', chatId);

            // Save to user's chat
            await addDoc(collection(db, 'chats', chatId, 'messages'), {
                sender: auth.currentUser.uid,
                text: text,
                timestamp: serverTimestamp()
            });

            // Update user's recent chats
            await setDoc(doc(db, 'userChats', currentChatUserId, 'chats', chatId), {
                partnerName: currentChatCeleb.name,
                partnerAvatar: currentChatCeleb.avatar,
                partnerId: auth.currentUser.uid,
                isCeleb: true,
                lastMessage: text,
                lastTimestamp: Date.now(),
                unreadCount: increment(1)
            }, { merge: true });

            // Log this admin reply in adminMessages
            await addDoc(collection(db, 'adminMessages'), {
                userId: currentChatUserId,
                userName: currentChatUserData.name,
                userAvatar: currentChatUserData.avatar,
                celebrity: currentChatCeleb.name,
                message: text,
                timestamp: serverTimestamp(),
                read: true,
                fromAdmin: true,
                chatId: chatId
            });

            input.value = '';
        };

        window.closeChatWindow = () => {
            document.getElementById('chatWindow').style.display = 'none';
            if (chatUnsubscribe) chatUnsubscribe();
            currentChatUserId = null;
            currentChatCeleb = null;
            currentChatUserData = null;
        };

        // ========== USER MANAGEMENT ==========
        function filterUsers() {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const filtered = users.filter(u => u.fullName?.toLowerCase().includes(search) || u.email?.toLowerCase().includes(search));
            renderUsers(filtered);
        }

        function renderUsers(userList) {
            const container = document.getElementById('usersList');
            container.innerHTML = userList.map(u => `
                <div class="card ${u.blocked ? 'blocked' : ''}">
                    <img src="${u.avatar || defaultAvatar}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                    <div><strong>${u.fullName}</strong> <span class="badge">VIP ${u.vipLevel}</span></div>
                    <div style="font-size:0.8rem; color:#aaa;">${u.email}</div>
                    <div class="actions">
                        <button class="small" onclick="changeVIP('${u.id}', ${u.vipLevel})">VIP</button>
                        <button class="small danger" onclick="deleteUser('${u.id}')">Delete</button>
                        <button class="small" onclick="notifyUser('${u.id}', '${u.fullName}')">Notify</button>
                        <button class="small warning" onclick="toggleBlock('${u.id}', ${u.blocked})">${u.blocked ? 'Unblock' : 'Block'}</button>
                    </div>
                </div>
            `).join('');
        }

        window.changeVIP = async (userId, current) => {
            const newVIP = prompt(`Enter new VIP level (current: ${current}):`);
            if (newVIP && !isNaN(newVIP) && newVIP >= 1) {
                await updateDoc(doc(db, 'users', userId), { vipLevel: parseInt(newVIP) });
                Toastify({ text: "VIP updated", backgroundColor: "green" }).showToast();
            }
        };

        window.deleteUser = async (userId) => {
            if (confirm('Delete this user? This cannot be undone.')) {
                await deleteDoc(doc(db, 'users', userId));
                Toastify({ text: "User deleted", backgroundColor: "green" }).showToast();
            }
        };

        window.toggleBlock = async (userId, currentlyBlocked) => {
            await updateDoc(doc(db, 'users', userId), { blocked: !currentlyBlocked });
            Toastify({ text: `User ${currentlyBlocked ? 'unblocked' : 'blocked'}`, backgroundColor: "green" }).showToast();
        };

        document.getElementById('searchUsers').addEventListener('input', filterUsers);

        // ========== POST MANAGEMENT ==========
        function renderPosts() {
            const container = document.getElementById('postsList');
            container.innerHTML = posts.map(p => `
                <div class="card">
                    <div><strong>${p.userName}</strong></div>
                    <div style="font-size:0.8rem;">${p.caption?.substring(0,50)}${p.caption?.length > 50 ? '...' : ''}</div>
                    <div class="actions">
                        <button class="small danger" onclick="deletePost('${p.id}')">Delete</button>
                        <button class="small warning" onclick="blockUser('${p.userId}')">Block User</button>
                    </div>
                </div>
            `).join('');
        }

        window.deletePost = async (postId) => {
            if (confirm('Delete this post?')) {
                await deleteDoc(doc(db, 'posts', postId));
                Toastify({ text: "Post deleted", backgroundColor: "green" }).showToast();
            }
        };

        window.blockUser = async (userId) => {
            await updateDoc(doc(db, 'users', userId), { blocked: true });
            Toastify({ text: "User blocked", backgroundColor: "green" }).showToast();
        };

        // ========== CELEBRITY MANAGEMENT ==========
        function renderCelebs() {
            const container = document.getElementById('celebsList');
            container.innerHTML = celebs.map(c => `
                <div class="card">
                    <img src="${c.img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;" onerror="this.src='${defaultAvatar}'">
                    <div><strong>${c.name}</strong></div>
                    <div class="actions">
                        <button class="small danger" onclick="deleteCeleb('${c.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.addCelebrity = async () => {
            const name = document.getElementById('celebName').value.trim();
            const img = document.getElementById('celebImg').value.trim();
            if (!name || !img) return Toastify({ text: "Enter name and image URL" }).showToast();
            await addDoc(collection(db, 'celebrities'), { name, img });
            document.getElementById('celebName').value = '';
            document.getElementById('celebImg').value = '';
            Toastify({ text: "Celebrity added", backgroundColor: "green" }).showToast();
        };

        window.deleteCeleb = async (celebId) => {
            if (confirm('Delete this celebrity?')) {
                await deleteDoc(doc(db, 'celebrities', celebId));
                Toastify({ text: "Celebrity deleted", backgroundColor: "green" }).showToast();
            }
        };

        // ========== PRODUCT MANAGEMENT ==========
        function renderProducts() {
            const container = document.getElementById('productsList');
            container.innerHTML = products.map(p => `
                <div class="card">
                    <div><strong>${p.name}</strong> - $${p.price}</div>
                    <div class="actions">
                        <button class="small" onclick="editProduct('${p.id}', '${p.name}', ${p.price}, '${p.icon || 'box'}')">Edit</button>
                        <button class="small danger" onclick="deleteProduct('${p.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.addProduct = async () => {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const icon = document.getElementById('productIcon').value.trim() || 'box';
            if (!name || isNaN(price)) return Toastify({ text: "Enter valid name and price" }).showToast();
            await addDoc(collection(db, 'products'), { name, price, icon });
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productIcon').value = 'box';
            Toastify({ text: "Product added", backgroundColor: "green" }).showToast();
        };

        window.deleteProduct = async (productId) => {
            if (confirm('Delete this product?')) {
                await deleteDoc(doc(db, 'products', productId));
                Toastify({ text: "Product deleted", backgroundColor: "green" }).showToast();
            }
        };

        window.editProduct = async (id, oldName, oldPrice, oldIcon) => {
            const name = prompt("Product name:", oldName);
            if (name === null) return;
            const price = parseFloat(prompt("Price:", oldPrice));
            if (isNaN(price)) return;
            const icon = prompt("Icon (Font Awesome name):", oldIcon) || 'box';
            await updateDoc(doc(db, 'products', id), { name, price, icon });
            Toastify({ text: "Product updated", backgroundColor: "green" }).showToast();
        };

        // ========== NOTIFICATIONS ==========
        document.getElementById('notifyTarget').addEventListener('change', (e) => {
            document.getElementById('notifyUserId').style.display = e.target.value === 'user' ? 'block' : 'none';
        });

        window.sendNotification = async () => {
            const target = document.getElementById('notifyTarget').value;
            const userId = document.getElementById('notifyUserId').value;
            const title = document.getElementById('notifyTitle').value.trim();
            const message = document.getElementById('notifyMessage').value.trim();
            const link = document.getElementById('notifyLink').value.trim();
            if (!title || !message) return Toastify({ text: "Fill title and message" }).showToast();

            const notification = {
                type: 'admin',
                title,
                message,
                from: 'System',
                avatar: defaultAvatar,
                timestamp: serverTimestamp(),
                read: false,
                link: link || ''
            };

            if (target === 'all') {
                const usersSnap = await getDocs(collection(db, 'users'));
                const batch = writeBatch(db);
                usersSnap.forEach(docSnap => {
                    const notifRef = doc(collection(db, 'notifications'));
                    batch.set(notifRef, { ...notification, userId: docSnap.id });
                });
                await batch.commit();
                Toastify({ text: "Notifications sent to all users", backgroundColor: "green" }).showToast();
            } else {
                if (!userId) return Toastify({ text: "Enter user ID" }).showToast();
                await addDoc(collection(db, 'notifications'), { ...notification, userId });
                Toastify({ text: "Notification sent", backgroundColor: "green" }).showToast();
            }
        };

        window.notifyUser = (userId, userName) => {
            document.getElementById('notifyTarget').value = 'user';
            document.getElementById('notifyUserId').value = userId;
            document.getElementById('notifyUserId').style.display = 'block';
            document.getElementById('notifyTitle').focus();
            Toastify({ text: `Now sending notification to ${userName}`, backgroundColor: "green" }).showToast();
            document.querySelector('[data-page="settings"]').click();
        };

        // ========== GLOBAL MUSIC ==========
        window.setMusicUrl = async () => {
            const url = document.getElementById('musicUrl').value.trim();
            await setDoc(doc(db, 'settings', 'music'), { url });
            Toastify({ text: "Music URL updated", backgroundColor: "green" }).showToast();
        };
    </script>
</body>
</html>
