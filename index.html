       <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CMC Fan Platform</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Preload default wallpaper -->
    <link rel="preload" as="image" href="https://res.cloudinary.com/dnkll2fha/image/upload/f_auto,q_auto,w_800/v1/wallpapers/static17">
    
    <style>
        /* ========== RESET & GLOBAL ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: #0b141a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* ========== AUTH ========== */
        #auth-container {
            background: #1f2c34;
            border-radius: 24px;
            padding: 30px 24px;
            max-width: 400px;
            margin: 30px auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
        }

        .auth-logo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid #8e44ad;
            margin-bottom: 20px;
            object-fit: cover;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: #2a3942;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            color: #8696a0;
            transition: 0.2s;
        }
        .auth-tab.active {
            background: #8e44ad;
            color: #fff;
        }

        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }

        input {
            width: 100%;
            padding: 14px 16px;
            margin: 8px 0;
            border: none;
            border-radius: 30px;
            background: #2a3942;
            color: white;
            font-size: 16px;
        }
        input::placeholder {
            color: #8696a0;
        }

        button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 30px;
            background: #8e44ad;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #9b59b6;
        }

        #message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 16px;
        }

        /* ========== MAIN APP ========== */
        #mainApp {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: #0b141a;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #1f2c34;
            border-bottom: 1px solid #2a3942;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            font-size: 1.1rem;
        }
        .logo-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #8e44ad;
            object-fit: cover;
        }
        .notification-wrapper {
            position: relative;
            display: inline-block;
        }
        #bellIcon {
            font-size: 1.4rem;
            cursor: pointer;
            color: #8696a0;
        }
        #bellIcon.has-notifications {
            color: #8e44ad;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #1f2c34;
        }
        #headerBal {
            margin-left: 8px;
            font-size: 0.9rem;
            color: #2ecc71;
            font-weight: bold;
        }

        /* Notification dropdown */
        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            width: 320px;
            max-width: 90vw;
            max-height: 70vh;
            background: #1f2c34;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #2a3942;
            z-index: 2000;
            display: none;
            overflow: hidden;
        }
        .notification-dropdown.active {
            display: block;
        }
        .notification-header {
            padding: 12px 15px;
            border-bottom: 1px solid #2a3942;
            display: flex;
            justify-content: space-between;
            background: #1f2c34;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .notification-list {
            max-height: 350px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 12px;
            border-bottom: 1px solid #2a3942;
            cursor: pointer;
            display: flex;
            gap: 10px;
            align-items: flex-start;
            transition: background 0.2s;
        }
        .notification-item:hover {
            background: #2a3942;
        }
        .notification-item.unread {
            background: rgba(142,68,173,0.2);
        }
        .notification-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        .notification-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .notification-message {
            font-size: 0.8rem;
            color: #aaa;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .notification-time {
            font-size: 0.65rem;
            color: #666;
            margin-top: 3px;
        }
        .notification-actions {
            display: flex;
            padding: 10px 12px;
            gap: 8px;
            border-top: 1px solid #2a3942;
            background: #1f2c34;
            position: sticky;
            bottom: 0;
            z-index: 2;
        }
        .notification-actions button {
            flex: 1;
            padding: 8px;
            background: #2a3942;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            margin: 0;
        }
        .notification-actions button:hover {
            background: #3a4a54;
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: #1f2c34;
            padding: 8px 0;
            border-top: 1px solid #2a3942;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #8696a0;
            font-size: 12px;
            cursor: pointer;
        }
        .nav-item.active {
            color: #8e44ad;
        }
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .page {
            display: none;
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            margin-bottom: 70px;
        }
        .page.active {
            display: block;
        }

        .card {
            background: #1f2c34;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .wallet-card {
            background: linear-gradient(135deg, #8e44ad, #3a1c71);
            text-align: center;
            padding: 30px 20px;
        }
        .balance-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
        }
        .vip-badge {
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* ========== PROFILE CARD (HOME) ========== */
        .profile-card-mini {
            background: #1f2c34;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 15px;
            border: 1px solid #2a3942;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .profile-avatar-mini {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid #8e44ad;
            object-fit: cover;
            cursor: pointer;
        }
        .profile-info-mini {
            flex: 1;
        }
        .profile-name-mini {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .profile-vip-mini {
            background: rgba(0,0,0,0.3);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .profile-vip-mini i {
            color: #f1c40f;
            margin-right: 4px;
        }

        /* ========== PROFILE PAGE AVATAR ========== */
        .profile-avatar-large {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
            border: 4px solid #8e44ad;
            box-shadow: 0 0 20px rgba(142,68,173,0.5);
            margin: 0 auto;
        }
        .profile-pic-edit {
            position: relative;
            display: inline-block;
        }
        .profile-pic-edit .profile-avatar-large {
            cursor: pointer;
        }
        .profile-pic-edit i {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #8e44ad;
            border-radius: 50%;
            padding: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* ========== FIND FRIENDS AVATAR ========== */
        .friend-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            object-position: center;
            border: 2px solid #8e44ad;
        }

        /* ========== CHAT AVATAR ========== */
        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #8e44ad;
        }

        /* Profile page layout */
        .profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        .settings-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            color: #8696a0;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            z-index: 10;
        }
        .settings-icon:hover {
            color: #8e44ad;
            background: rgba(255,255,255,0.1);
        }
        
        .profile-music-icon {
            position: absolute;
            top: 10px;
            right: 60px;
            font-size: 1.5rem;
            color: #8e44ad !important;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            z-index: 10;
            background: rgba(0,0,0,0.2);
        }
        .profile-music-icon:hover {
            background: rgba(142,68,173,0.3);
            transform: scale(1.1);
        }
        .profile-music-icon.playing {
            animation: pulse-purple 2s infinite;
        }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(142, 68, 173, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(142, 68, 173, 0); }
            100% { box-shadow: 0 0 0 0 rgba(142, 68, 173, 0); }
        }

        .settings-menu {
            position: absolute;
            top: 50px;
            right: 10px;
            background: #1f2c34;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #2a3942;
            z-index: 100;
            display: none;
            min-width: 200px;
            overflow: hidden;
        }
        .settings-menu.active {
            display: block;
        }
        .settings-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
        }
        .settings-menu-item:hover {
            background: #2a3942;
        }
        .settings-menu-item i {
            width: 20px;
            color: #8e44ad;
        }

        .celeb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .celeb-card {
            background: #2a3942;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        .celeb-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #8e44ad;
            margin-bottom: 8px;
        }
        .celeb-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
        .verified-badge {
            color: #1877f2;
            font-size: 0.8rem;
            margin-left: 4px;
        }
        .unread-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            font-weight: bold;
        }

        .recent-chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #2a3942;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }
        .recent-chat-item:hover {
            background: #3a4a54;
        }
        .recent-chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        .recent-chat-info {
            flex: 1;
        }
        .recent-chat-name {
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .recent-chat-message {
            font-size: 0.85rem;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        .recent-chat-time {
            font-size: 0.7rem;
            color: #aaa;
        }

        .market-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .product-card {
            background: #2a3942;
            border-radius: 12px;
            overflow: hidden;
        }
        .product-img {
            height: 100px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 2rem;
        }
        .product-info {
            padding: 10px;
        }
        .product-title {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .product-price {
            color: #2ecc71;
            font-weight: 800;
            margin: 5px 0;
        }
        .btn-buy {
            background: #8e44ad;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
        }

        .action-btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        .btn-deposit {
            background: #2ecc71;
            color: white;
        }
        .btn-withdraw {
            background: #e74c3c;
            color: white;
        }
        .btn-primary {
            background: #8e44ad;
            color: white;
        }

        .upload-post-btn {
            background: linear-gradient(145deg, #8e44ad, #6c3483);
            color: white;
            border: none;
            border-radius: 40px;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px auto;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 4px 15px rgba(142,68,173,0.4);
        }
        .upload-post-btn i {
            font-size: 1.2rem;
        }
        .upload-post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(142,68,173,0.6);
        }
        .upload-post-btn.limited {
            background: #555;
            box-shadow: none;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .upload-post-btn.limited:hover {
            transform: none;
        }

        /* ========== POST CARD ========== */
        .posts-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 20px;
        }
        .post-card {
            background: #1f2c34;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #2a3942;
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
        }
        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        .post-info {
            flex: 1;
        }
        .post-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        .post-time {
            font-size: 0.75rem;
            color: #8696a0;
        }
        .post-media-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            overflow: hidden;
            background: #000;
            cursor: pointer;
        }
        .post-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 15px;
        }
        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .video-overlay i {
            font-size: 4rem;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .video-overlay.fade-out {
            opacity: 0;
        }
        .post-caption {
            padding: 15px;
            font-size: 0.95rem;
        }
        .post-actions {
            display: flex;
            gap: 20px;
            padding: 10px 15px 15px;
            border-top: 1px solid #2a3942;
        }
        .post-like, .post-comment {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #8696a0;
        }
        .post-like.liked {
            color: #ff4d4d;
        }
        .post-like i, .post-comment i {
            font-size: 1.2rem;
        }

        /* ===== FOLLOW BUTTON ===== */
        .follow-btn {
            background: #8e44ad;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            width: auto;
            margin: 0;
        }
        .follow-btn.following {
            background: #2a3942;
            color: #aaa;
        }
        .follow-btn:hover {
            transform: scale(1.05);
        }

        /* ===== USER POPUP MODAL ===== */
        .user-popup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .user-popup-content {
            background: #1f2c34;
            max-width: 400px;
            width: 100%;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 2px solid #8e44ad;
        }
        .user-popup-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #8e44ad;
            margin: 0 auto 15px;
        }
        .user-popup-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .user-popup-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
        }
        .stat-item {
            text-align: center;
        }
        .stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: #8e44ad;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #aaa;
        }
        .user-popup-follow {
            margin: 15px 0;
        }
        .user-popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .user-popup-close:hover {
            color: #e74c3c;
        }

        /* ===== CHAT VERIFIED ICON (SMALLER) ===== */
        .chat-name .verified-badge {
            font-size: 1rem !important;
            margin-left: 5px;
        }

        /* ===== PROFILE FOLLOW STATS ===== */
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }

        .comment-section {
            padding: 0 15px 15px;
            border-top: 1px solid #2a3942;
            background: #1a252f;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .comment-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #2a3942;
        }
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .comment-content {
            flex: 1;
        }
        .comment-author {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .comment-text {
            font-size: 0.9rem;
            margin: 2px 0;
        }
        .comment-time {
            font-size: 0.65rem;
            color: #8696a0;
        }
        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .comment-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
        }
        .comment-send {
            background: #8e44ad;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
        }

        .chat-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0b141a;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .chat-background-video,
        .chat-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
        }
        .chat-background-video {
            display: none;
        }
        .chat-background-image {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.3s ease;
        }
        .chat-background-image.moving {
            animation: moveBackground 30s linear infinite;
        }
        @keyframes moveBackground {
            0% { transform: scale(1) translate(0, 0); }
            25% { transform: scale(1.03) translate(-0.5%, -0.5%); }
            50% { transform: scale(1.05) translate(-1%, 0.5%); }
            75% { transform: scale(1.03) translate(0.5%, 1%); }
            100% { transform: scale(1) translate(0, 0); }
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(31,44,52,0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 1;
        }
        .chat-header i {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .chat-header img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #8e44ad;
        }
        .chat-header .chat-info {
            flex: 1;
            margin-left: 10px;
        }
        .chat-header .chat-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .chat-header .online-status {
            font-size: 0.75rem;
            color: #2ecc71;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            word-wrap: break-word;
        }
        .message.sent {
            align-self: flex-end;
            background: #8e44ad;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            align-self: flex-start;
            background: #2a3942;
            color: white;
            border-bottom-left-radius: 4px;
        }
        .message-time {
            font-size: 0.65rem;
            opacity: 0.8;
            display: block;
            margin-top: 5px;
        }
        .chat-input-area {
            display: flex;
            padding: 15px;
            background: rgba(31,44,52,0.9);
            backdrop-filter: blur(10px);
            gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: relative;
            z-index: 1;
        }
        .chat-input {
            flex: 1;
            background: #2a3942;
            border: none;
            padding: 12px;
            border-radius: 25px;
            color: white;
        }
        .send-btn, .chat-gift-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #8e44ad;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.2s;
        }
        .chat-gift-btn:hover, .send-btn:hover {
            transform: scale(1.1);
            background: #9b59b6;
        }

        /* ========== FIND FRIENDS LIST ========== */
        .friend-card {
            display: flex;
            align-items: center;
            gap: 15px;
            background: #2a3942;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        .friend-card:hover {
            background: #3a4a54;
        }
        .friend-info {
            flex: 1;
        }
        .friend-name {
            font-weight: 600;
        }
        .friend-vip {
            font-size: 0.8rem;
            color: #aaa;
        }

        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .wallpaper-item {
            aspect-ratio: 16/9;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
            position: relative;
            background-color: #2a3942;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .wallpaper-item.selected {
            border-color: #8e44ad;
            transform: scale(1.02);
        }
        .wallpaper-item .preview-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #fff;
        }
        .wallpaper-item.moving::after {
            content: "ðŸŽ¬";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1rem;
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: #1f2c34;
            width: 100%;
            max-width: 550px;
            padding: 25px;
            border-radius: 20px;
            position: relative;
            border: 1px solid #8e44ad;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .close-modal:hover {
            color: #e74c3c;
        }
        .input-box {
            width: 100%;
            padding: 12px;
            background: #2a3942;
            border: 1px solid #333;
            border-radius: 12px;
            color: white;
            margin-bottom: 10px;
        }
        textarea.input-box {
            min-height: 80px;
            resize: vertical;
        }

        /* Deposit method selector */
        .deposit-method-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .method-btn {
            flex: 1;
            padding: 12px;
            background: #2a3942;
            border: 1px solid #8e44ad;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
        }
        .method-btn.active {
            background: #8e44ad;
        }
        .method-btn i {
            margin-right: 8px;
        }

        .crypto-address {
            background: #2a3942;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .crypto-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .crypto-header img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        .address-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1f2c34;
            padding: 10px;
            border-radius: 8px;
        }
        .address-box span {
            flex: 1;
            font-family: monospace;
            font-size: 0.9rem;
            word-break: break-all;
        }
        .copy-btn {
            background: #8e44ad;
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            width: auto;
            margin: 0;
        }

        .gift-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .gift-card-item {
            background: #2a3942;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .gift-card-item:hover {
            border-color: #8e44ad;
            transform: translateY(-2px);
        }
        .gift-card-item i {
            font-size: 2rem;
            color: #8e44ad;
            margin-bottom: 8px;
        }
        .gift-card-item span {
            font-size: 0.8rem;
            display: block;
        }

        .redeem-section {
            margin-top: 20px;
            border-top: 1px solid #2a3942;
            padding-top: 20px;
        }
        .redeem-btn {
            background: #8e44ad;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px;
            width: 100%;
            cursor: pointer;
            font-weight: 600;
        }

        .gift-store {
            background: #1f2c34;
            border-radius: 20px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .gift-store-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #8e44ad, #3498db, #9b59b6, #2980b9);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            opacity: 0.3;
            z-index: 0;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .gift-store-content {
            position: relative;
            z-index: 1;
        }
        .bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            top: 0;
            left: 0;
            z-index: 0;
        }
        .bubble {
            position: absolute;
            bottom: -100px;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            animation: rise 10s infinite ease-in;
        }
        .bubble:nth-child(1) { left: 10%; width: 60px; height: 60px; animation-duration: 8s; }
        .bubble:nth-child(2) { left: 20%; width: 30px; height: 30px; animation-duration: 12s; animation-delay: 2s; }
        .bubble:nth-child(3) { left: 35%; width: 50px; height: 50px; animation-duration: 10s; animation-delay: 1s; }
        .bubble:nth-child(4) { left: 50%; width: 80px; height: 80px; animation-duration: 14s; animation-delay: 3s; }
        .bubble:nth-child(5) { left: 65%; width: 40px; height: 40px; animation-duration: 9s; animation-delay: 2.5s; }
        .bubble:nth-child(6) { left: 80%; width: 70px; height: 70px; animation-duration: 11s; animation-delay: 1.5s; }
        .bubble:nth-child(7) { left: 90%; width: 45px; height: 45px; animation-duration: 13s; animation-delay: 4s; }
        @keyframes rise {
            0% { bottom: -100px; transform: translateX(0); }
            100% { bottom: 1080px; transform: translateX(100px); }
        }
        .gift-store-search {
            margin-bottom: 20px;
        }
        .store-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .store-item {
            background: #2a3942;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .store-item:hover {
            border-color: #8e44ad;
            transform: translateY(-2px);
        }
        .store-item i {
            font-size: 2.5rem;
            color: #8e44ad;
            margin-bottom: 10px;
        }
        .store-item .name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .store-item .price {
            color: #2ecc71;
            font-weight: 700;
        }

        /* Floating gift button */
        .gift-store-float {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 65px;
            height: 65px;
            background: #8e44ad;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(142,68,173,0.6);
            z-index: 2600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .gift-store-float:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 25px rgba(142,68,173,0.8);
        }
        .gift-store-float i {
            font-size: 1.8rem;
            color: white;
        }
        .gift-store-float span {
            font-size: 10px;
            color: white;
            margin-top: 2px;
        }

        .gift-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        .gift-spinner .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(142,68,173,0.3);
            border-top: 5px solid #8e44ad;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .gift-spinner img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 20px 0;
        }

        .blackhawk-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            border: 2px solid #8e44ad;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 0 50px rgba(142,68,173,0.5);
            animation: fadeInOut 3s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }
        .blackhawk-popup h2 {
            color: #8e44ad;
            margin-bottom: 10px;
        }
        .blackhawk-popup p {
            color: #aaa;
        }

        .spinner-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0b141a;
            z-index: 6000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(142,68,173,0.3);
            border-top: 5px solid #8e44ad;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #adminCelebForm {
            margin-top: 20px;
            padding: 15px;
            background: #2a3942;
            border-radius: 12px;
            display: none;
        }
        #adminCelebForm h4 {
            color: #8e44ad;
            margin-bottom: 10px;
        }

        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000dd;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .call-box {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 20px;
            width: 95%;
            max-width: 400px;
            text-align: center;
            border: 2px solid #8e44ad;
            box-shadow: 0 0 30px rgba(142,68,173,0.5);
        }
        .call-avatar-container {
            margin: 15px 0;
            position: relative;
            display: inline-block;
        }
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #8e44ad;
        }
        .pulse-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            border: 3px solid transparent;
            animation: pulse 1.5s ease-out infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); border-color: #ff0000; box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
            25% { border-color: #ff7f00; }
            50% { transform: scale(1.05); border-color: #ffff00; box-shadow: 0 0 0 15px rgba(255,255,0,0); }
            75% { border-color: #00ff00; }
            100% { transform: scale(0.95); border-color: #0000ff; box-shadow: 0 0 0 0 rgba(0,0,255,0); }
        }
        .call-status {
            font-size: 1.2rem;
            margin: 10px 0;
            color: #fff;
            text-shadow: 0 0 10px #8e44ad;
        }
        .call-box video {
            width: 100%;
            max-height: 200px;
            background: black;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .call-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        .call-buttons button {
            margin: 5px;
            padding: 8px 12px;
        }

        .support-chat-float {
            position: fixed;
            bottom: 180px;
            right: 20px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
            background-size: 300% 300%;
            animation: rainbow 3s ease infinite;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 2601;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .support-chat-float:hover {
            transform: scale(1.1);
        }
        .support-chat-float i {
            font-size: 2rem;
            color: white;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .notification-empty {
            padding: 20px;
            text-align: center;
            color: #8696a0;
        }
        .notification-empty i {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        .transaction-item {
            background: #2a3942;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .transaction-details {
            flex: 1;
        }
        .transaction-type {
            font-weight: 600;
        }
        .transaction-amount {
            color: #2ecc71;
        }
        .transaction-negative {
            color: #e74c3c;
        }
        .transaction-time {
            font-size: 0.75rem;
            color: #666;
        }
        .transaction-status {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .status-pending { background: #f39c12; }
        .status-completed { background: #2ecc71; }
        .status-failed { background: #e74c3c; }

        .spin-fast { animation-duration: 0.5s !important; }
        .spin-medium { animation-duration: 0.8s !important; }
        .spin-slow { animation-duration: 1.2s !important; }
    </style>
</head>
<body>
    <!-- Floating gift button (purple, only on homepage) -->
    <div class="gift-store-float" id="giftStoreFloat" onclick="openGiftStoreWithSpinner()" style="display: none;">
        <i class="fas fa-gift"></i>
        <span>GIFT</span>
    </div>

    <!-- Floating rainbow support button (only on Me page) -->
    <div class="support-chat-float" id="supportChatFloat" onclick="openAdminChat()">
        <i class="fas fa-headset"></i>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
        <div id="auth-container">
            <img src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" class="auth-logo" alt="CMC Logo">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="toggleAuth('login')">Login</div>
                <div class="auth-tab" onclick="toggleAuth('register')">Create Account</div>
            </div>
            <div id="loginForm" class="auth-form active">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="loginUser()">Log In</button>
            </div>
            <div id="registerForm" class="auth-form">
                <input type="text" id="regName" placeholder="Full Name">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPassword" placeholder="Password">
                <button onclick="startRegistration()">Create Account</button>
            </div>
            <div id="message"></div>
        </div>
    </div>

    <!-- Spinner -->
    <div id="spinner" class="spinner-overlay">
        <div class="spinner"></div>
        <div id="spinnerText" style="margin-top:20px;">Loading...</div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <div class="logo-area">
                <img src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" class="logo-img">
                <span>CMC Fan</span>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="notification-wrapper">
                    <i class="fas fa-bell" id="bellIcon"></i>
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                    <div id="notificationDropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <h3 style="font-size: 1rem;">Notifications</h3>
                            <span id="notificationCount" style="font-size: 0.8rem;">0 new</span>
                        </div>
                        <div id="notificationList" class="notification-list"></div>
                        <div class="notification-actions">
                            <button onclick="markAllAsRead()">Mark Read</button>
                            <button onclick="clearAllNotifications()">Clear</button>
                        </div>
                    </div>
                </div>
                <span id="headerBal" style="margin-left:8px;">$0.00</span>
            </div>
        </div>

        <!-- PAGES -->
        <div id="home" class="page active">
            <div class="profile-card-mini" onclick="navTo('profile')" style="cursor: pointer;">
                <img id="homeProfileAvatar" class="profile-avatar-mini" src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" alt="Profile">
                <div class="profile-info-mini">
                    <div class="profile-name-mini" id="homeProfileName">Loading...</div>
                    <div class="profile-vip-mini" id="homeVipBadge">
                        <i class="fas fa-crown"></i> VIP <span id="homeVipLevel">1</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right" style="color: #8696a0;"></i>
            </div>

            <div class="card wallet-card">
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount" id="homeBalance">$0.00</div>
                <div class="vip-badge">VIP <span id="userVipLevel">1</span></div>
            </div>

            <h3>Active Celebrities</h3>
            <div style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;" id="homeCelebList"></div>
            
            <div class="card" onclick="navTo('market')">
                <h3><i class="fas fa-store" style="color: #8e44ad;"></i> New Arrivals</h3>
                <p style="color:#aaa;">Private Meet Cards, Tickets & More available now!</p>
            </div>
        </div>

        <div id="celebs" class="page">
            <input type="text" class="input-box" id="searchCelebs" placeholder="Search Celebrities...">
            <div id="allCelebGrid" class="celeb-grid"></div>
            <div id="adminCelebForm">
                <h4>Add Celebrity (Admin)</h4>
                <input type="text" id="newCelebName" class="input-box" placeholder="Name">
                <input type="url" id="newCelebImg" class="input-box" placeholder="Image URL">
                <button onclick="addCelebrity()">Add Celebrity</button>
            </div>
        </div>

        <div id="market" class="page">
            <h3>Celebrity Marketplace</h3>
            <div class="market-grid" id="productsGrid"></div>
        </div>

        <div id="chat" class="page">
            <h3>Find Friends</h3>
            <input type="text" class="input-box" id="searchUsers" placeholder="Search friends...">
            <div id="userList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div id="recent" class="page">
            <h3>Recent Chats</h3>
            <div id="recentChatsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div id="posts" class="page">
            <h3>Posts</h3>
            <div id="postsFeed" class="posts-feed"></div>
        </div>

        <div id="wallet" class="page">
            <div class="card wallet-card">
                <div class="balance-label">Available Funds</div>
                <div class="balance-amount" id="walletBalance">$0.00</div>
            </div>
            <button class="action-btn btn-deposit" onclick="openDepositModal()"><i class="fas fa-plus-circle"></i> Deposit</button>
            <button class="action-btn btn-withdraw" onclick="attemptWithdrawal()"><i class="fas fa-university"></i> Withdraw</button>
            
            <h3 style="margin: 20px 0 10px;">Transaction History</h3>
            <div id="transactionList" class="transaction-list"></div>
        </div>

        <div id="profile" class="page">
            <div class="profile-header">
                <i class="fas fa-cog settings-icon" onclick="toggleSettingsMenu()"></i>
                <i class="fas fa-music profile-music-icon" id="profileMusicIcon" onclick="toggleProfileMusic()" title="Play music"></i>
                
                <div class="settings-menu" id="settingsMenu">
                    <div class="settings-menu-item" onclick="openChangeNameModal()">
                        <i class="fas fa-user-edit"></i>
                        <span>Change Name</span>
                    </div>
                    <div class="settings-menu-item" onclick="openWallpaperModal()">
                        <i class="fas fa-image"></i>
                        <span>Change Chat Wallpaper</span>
                    </div>
                </div>
            </div>
            <div style="text-align: center;">
                <div class="profile-pic-edit">
                    <img id="profileAvatar" class="profile-avatar-large" src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" onclick="openAvatarModal()" alt="Profile">
                    <i class="fas fa-camera" onclick="openAvatarModal()"></i>
                </div>
                <h2 id="profileName" style="margin-top: 10px;">Loading...</h2>
                <div class="vip-badge">Verified Member</div>
                
                <div class="profile-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="profileFollowers">0</div>
                        <div class="stat-label">Followers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="profileFollowing">0</div>
                        <div class="stat-label">Following</div>
                    </div>
                </div>
            </div>
            <button class="upload-post-btn" id="uploadPostBtn"><i class="fas fa-plus-circle"></i> Create Post</button>
            <button class="action-btn" onclick="logout()" style="background:#333;">Log Out</button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i>Home</div>
            <div class="nav-item" onclick="navTo('market', this)"><i class="fas fa-store"></i>Shop</div>
            <div class="nav-item" onclick="navTo('celebs', this)"><i class="fas fa-star"></i>Stars</div>
            <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comment-dots"></i>Chat</div>
            <div class="nav-item" onclick="navTo('recent', this)"><i class="fas fa-history"></i>Recent</div>
            <div class="nav-item" onclick="navTo('posts', this)"><i class="fas fa-rss"></i>Posts</div>
            <div class="nav-item" onclick="navTo('wallet', this)"><i class="fas fa-wallet"></i>Wallet</div>
            <div class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i>Me</div>
        </div>
    </div>

    <!-- CHAT WINDOW -->
    <div id="chatInterface" class="chat-window">
        <video id="chatVideo" class="chat-background-video" loop muted playsinline preload="auto"></video>
        <div id="chatImageBg" class="chat-background-image"></div>
        <div class="chat-header">
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <img id="chatAvatar" class="chat-avatar" src="">
            <div class="chat-info">
                <div class="chat-name">
                    <span id="chatName"></span>
                    <i class="fas fa-check-circle verified-badge" id="chatVerifiedIcon" style="display: none;"></i>
                </div>
                <div class="online-status">Online</div>
            </div>
            <div id="callButtons" style="display: none; gap: 10px; margin-right: 10px;">
                <button id="audioCallBtn" style="background: none; border: none; color: #8e44ad; font-size: 1.2rem; cursor: pointer;">ðŸ“ž</button>
                <button id="videoCallBtn" style="background: none; border: none; color: #8e44ad; font-size: 1.2rem; cursor: pointer;">ðŸŽ¥</button>
            </div>
            <button class="chat-gift-btn" onclick="openSendGiftModal()" title="Send a gift">
                <i class="fas fa-gift"></i>
            </button>
        </div>
        <div id="messageContainer" class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="msgInput" class="chat-input" placeholder="Type message...">
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- USER POPUP MODAL (also used for celebrities) -->
    <div id="userPopupModal" class="user-popup-modal">
        <div class="user-popup-content">
            <span class="user-popup-close" onclick="closeUserPopup()">&times;</span>
            <img id="popupAvatar" class="user-popup-avatar" src="" alt="User">
            <div id="popupName" class="user-popup-name"></div>
            <div id="popupVip" class="vip-badge" style="margin-bottom: 10px;"></div>
            <div class="user-popup-stats">
                <div class="stat-item">
                    <div class="stat-number" id="popupFollowers">0</div>
                    <div class="stat-label">Followers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="popupFollowing">0</div>
                    <div class="stat-label">Following</div>
                </div>
            </div>
            <div class="user-popup-follow">
                <button id="popupFollowBtn" class="follow-btn" onclick="toggleFollowFromPopup()">Follow</button>
            </div>
            <button class="action-btn btn-primary" onclick="openUserChatFromPopup()" style="margin-top: 10px;">Send Message</button>
        </div>
    </div>

    <!-- DEPOSIT MODAL -->
    <div id="depositModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('depositModal')">&times;</span>
            <h3>Deposit Funds</h3>
            <div class="deposit-method-selector">
                <div class="method-btn active" onclick="selectDepositMethod('crypto')">
                    <i class="fas fa-coins"></i> Crypto
                </div>
                <div class="method-btn" onclick="selectDepositMethod('gift')">
                    <i class="fas fa-gift"></i> Gift Cards
                </div>
            </div>
            <div id="cryptoDepositSection">
                <p style="color:#aaa; margin-bottom:15px;">Send cryptocurrency to the addresses below. Funds will be credited after network confirmations.</p>
                <div class="crypto-address">
                    <div class="crypto-header">
                        <img src="https://i.ibb.co/N68S0Nt3/Bitcoin.png" alt="Bitcoin" onerror="this.src='https://via.placeholder.com/30'">
                        <span style="font-weight:600;">Bitcoin (BTC)</span>
                    </div>
                    <div class="address-box">
                        <span>bc1qm3mfz4ytpkthcdcl0fep3ndzq2g3jxme4de05p</span>
                        <button class="copy-btn" onclick="copyToClipboard('bc1qm3mfz4ytpkthcdcl0fep3ndzq2g3jxme4de05p')">Copy</button>
                    </div>
                </div>
                <div class="crypto-address">
                    <div class="crypto-header">
                        <img src="https://i.ibb.co/d0MHYK27/Ethereum.png" alt="Ethereum" onerror="this.src='https://via.placeholder.com/30'">
                        <span style="font-weight:600;">Ethereum (ERC20)</span>
                    </div>
                    <div class="address-box">
                        <span>0x4507B199d512f0C44E021D4E020a99eB9Eb9023B</span>
                        <button class="copy-btn" onclick="copyToClipboard('0x4507B199d512f0C44E021D4E020a99eB9Eb9023B')">Copy</button>
                    </div>
                </div>
            </div>
            <div id="giftDepositSection" style="display: none;">
                <p style="color:#aaa; margin-bottom:15px;">Select a gift card type to redeem:</p>
                <div class="gift-grid">
                    <div class="gift-card-item" onclick="openRedeemModal('Apple iTunes')">
                        <i class="fab fa-apple"></i>
                        <span>Apple iTunes</span>
                    </div>
                    <div class="gift-card-item" onclick="openRedeemModal('Steam Wallet')">
                        <i class="fab fa-steam"></i>
                        <span>Steam Wallet</span>
                    </div>
                    <div class="gift-card-item" onclick="openRedeemModal('Google Play')">
                        <i class="fab fa-google-play"></i>
                        <span>Google Play</span>
                    </div>
                    <div class="gift-card-item" onclick="openRedeemModal('Razer Gold')">
                        <i class="fas fa-gamepad"></i>
                        <span>Razer Gold</span>
                    </div>
                    <div class="gift-card-item" onclick="openRedeemModal('Amazon')">
                        <i class="fab fa-amazon"></i>
                        <span>Amazon</span>
                    </div>
                    <div class="gift-card-item" onclick="openRedeemModal('Walmart')">
                        <i class="fas fa-store"></i>
                        <span>Walmart</span>
                    </div>
                </div>
                <div class="redeem-section">
                    <button class="redeem-btn" onclick="openRedeemModal()">Redeem Gift Card</button>
                </div>
            </div>
        </div>
    </div>

    <!-- REDEEM GIFT CARD MODAL -->
    <div id="redeemModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('redeemModal')">&times;</span>
            <h3>Redeem Gift Card</h3>
            <select id="redeemCardType" class="input-box">
                <option value="">Select Card Type</option>
                <option value="Apple iTunes">Apple iTunes</option>
                <option value="Steam Wallet">Steam Wallet</option>
                <option value="Google Play">Google Play</option>
                <option value="Razer Gold">Razer Gold</option>
                <option value="Amazon">Amazon</option>
                <option value="Walmart">Walmart</option>
                <option value="Target">Target</option>
                <option value="eBay">eBay</option>
                <option value="Visa">Visa</option>
                <option value="Mastercard">Mastercard</option>
                <option value="American Express">American Express</option>
                <option value="PlayStation">PlayStation</option>
                <option value="Xbox">Xbox</option>
                <option value="Roblox">Roblox</option>
                <option value="Nintendo eShop">Nintendo eShop</option>
                <option value="Starbucks">Starbucks</option>
            </select>
            <input type="text" id="redeemCode" class="input-box" placeholder="Enter 16-digit scratch code" maxlength="16">
            <input type="number" id="redeemAmount" class="input-box" placeholder="Card Amount ($)" min="1">
            <button onclick="submitRedeemRequest()" id="redeemSubmitBtn" style="background: #8e44ad;">Submit for Verification</button>
            <div id="redeemStatus" class="status-message" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- GIFT CARD STORE MODAL (updated min/max) -->
    <div id="giftStoreModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="closeModal('giftStoreModal'); clearBlackhawkInterval();">&times;</span>
            <div id="giftStoreSpinner" style="display: flex; flex-direction: column; align-items: center; padding: 40px;">
                <div class="spinner" style="width: 80px; height: 80px;"></div>
                <img src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" style="width: 100px; height: 100px; border-radius: 50%; margin: 20px 0;">
                <p style="color:#8e44ad;">Loading Gift Store...</p>
            </div>
            <div id="giftStoreContent" style="display: none;">
                <div class="gift-store">
                    <div class="bubbles">
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                        <div class="bubble"></div>
                    </div>
                    <div class="gift-store-bg"></div>
                    <div class="gift-store-content">
                        <h2 style="color:#8e44ad; margin-bottom:20px;">Gift Card Store</h2>
                        <div class="gift-store-search">
                            <input type="text" id="giftStoreSearch" class="input-box" placeholder="Search gift cards..." oninput="filterGiftStore()">
                        </div>
                        <div class="store-grid" id="giftStoreGrid"></div>
                        <p style="text-align:center; color:#aaa; margin-top:20px; font-size:0.8rem;">
                            Trusted and controlled by Blackhawk Network Holdings
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GIFT PURCHASE MODAL (updated min/max to 50-2000) -->
    <div id="giftPurchaseModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('giftPurchaseModal')">&times;</span>
            <h3 id="purchaseCardTitle">Purchase Gift Card</h3>
            <div style="text-align:center; margin:20px 0;">
                <i id="purchaseCardIcon" class="fas fa-gift" style="font-size:3rem; color:#8e44ad;"></i>
            </div>
            <div style="background:#2a3942; border-radius:12px; padding:15px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>Available Balance:</span>
                    <span id="purchaseBalance">$0.00</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Min: $50</span>
                    <span>Max: $2000</span>
                </div>
            </div>
            <input type="number" id="purchaseAmount" class="input-box" placeholder="Enter amount ($50 - $2000)" min="50" max="2000">
            <div id="purchaseError" style="color:#e74c3c; font-size:0.9rem; margin-bottom:10px; display:none;"></div>
            <button onclick="processGiftPurchase()" id="purchaseBtn" style="background: #8e44ad;">Buy Now</button>
            <div id="purchaseStatus" class="status-message" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- PURCHASE RESULT MODAL -->
    <div id="purchaseResultModal" class="modal">
        <div class="modal-content" style="text-align:center;">
            <span class="close-modal" onclick="closeModal('purchaseResultModal')">&times;</span>
            <i class="fas fa-check-circle" style="font-size:3rem; color:#2ecc71; margin-bottom:15px;"></i>
            <h3>Purchase Successful!</h3>
            <p style="color:#aaa; margin:15px 0;">Your gift card code:</p>
            <div style="background:#2a3942; padding:15px; border-radius:12px; font-family:monospace; font-size:1.2rem; margin-bottom:15px;" id="purchasedCode">XXXX XXXX XXXX XXXX</div>
            <button class="copy-btn" onclick="copyToClipboard(document.getElementById('purchasedCode').innerText)" style="width:auto; margin:0 auto;">Copy Code</button>
        </div>
    </div>

    <!-- SEND GIFT MODAL (unchanged, 1-200) -->
    <div id="sendGiftModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('sendGiftModal')">&times;</span>
            <h3>Send a Gift</h3>
            <div id="sendGiftRecipientInfo" style="background:#2a3942; border-radius:12px; padding:15px; margin-bottom:15px; display:flex; align-items:center; gap:15px;">
                <img id="sendGiftAvatar" class="chat-avatar" src="">
                <div>
                    <div style="font-weight:600;" id="sendGiftName"></div>
                    <div style="font-size:0.8rem; color:#aaa;" id="sendGiftType"></div>
                </div>
            </div>
            <select id="sendGiftType" class="input-box">
                <option value="">Select Gift Type</option>
                <option value="ðŸŽ Basic Gift">ðŸŽ Basic Gift ($1 - $50)</option>
                <option value="ðŸŽ‰ Premium Gift">ðŸŽ‰ Premium Gift ($51 - $100)</option>
                <option value="ðŸ‘‘ VIP Gift">ðŸ‘‘ VIP Gift ($101 - $200)</option>
            </select>
            <input type="number" id="sendGiftAmount" class="input-box" placeholder="Amount ($1 - $200)" min="1" max="200">
            <div style="background:#2a3942; border-radius:12px; padding:15px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between;">
                    <span>Your Balance:</span>
                    <span id="sendGiftBalance">$0.00</span>
                </div>
            </div>
            <div id="sendGiftError" style="color:#e74c3c; font-size:0.9rem; margin-bottom:10px; display:none;"></div>
            <button onclick="processSendGift()" id="sendGiftBtn" style="background: #8e44ad;">Send Gift</button>
        </div>
    </div>

    <!-- BLACKHAWK POPUP -->
    <div id="blackhawkPopup" class="blackhawk-popup" style="display:none;">
        <h2>ðŸ”’ Trusted Partner</h2>
        <p>Controlled by Blackhawk Network Holdings</p>
    </div>

    <!-- POST UPLOAD MODAL -->
    <div id="postUploadModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('postUploadModal')">&times;</span>
            <h3>Create Post</h3>
            <textarea id="postCaption" class="input-box" placeholder="Write something..."></textarea>
            <input type="file" id="postFile" accept="image/*,video/*" class="input-box">
            <p style="color:#aaa; font-size:0.8rem;">Max video size: 40MB</p>
            <div id="postUploadStatus" style="margin-bottom:10px;"></div>
            <button class="action-btn btn-primary" onclick="uploadPost()">Post</button>
        </div>
    </div>

    <!-- AVATAR MODAL -->
    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('avatarModal')">&times;</span>
            <h3>Change Profile Picture</h3>
            <input type="file" id="avatarFileInput" accept="image/*" class="input-box">
            <p style="color:#aaa; font-size:0.8rem; margin-bottom:10px;">Minimum resolution: 500x500 pixels for best quality</p>
            <button class="action-btn btn-primary" onclick="uploadAvatar()">Upload</button>
            <div id="avatarUploadStatus" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- CHANGE NAME MODAL -->
    <div id="changeNameModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('changeNameModal')">&times;</span>
            <h3>Change Display Name</h3>
            <input type="text" id="newNameInput" class="input-box" placeholder="Enter new name">
            <button class="action-btn btn-primary" onclick="updateDisplayName()">Update Name</button>
            <div id="nameUpdateStatus" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- WALLPAPER MODAL -->
    <div id="wallpaperModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close-modal" onclick="closeModal('wallpaperModal')">&times;</span>
            <h3>Choose Chat Wallpaper</h3>
            <p style="color:#aaa; margin-bottom:10px;">Select a wallpaper for your chat background</p>
            <div class="wallpaper-grid" id="wallpaperGrid"></div>
            <button class="action-btn btn-primary" onclick="saveWallpaper()">Apply Wallpaper</button>
            <div id="wallpaperStatus" style="margin-top:10px;"></div>
        </div>
    </div>

    <!-- WITHDRAW MODAL -->
    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('withdrawModal')">&times;</span>
            <h3>Withdraw</h3>
            <p style="color:#aaa;">VIP 4+ required</p>
            <input type="number" id="withdrawAmount" class="input-box" placeholder="Amount">
            <input type="text" id="withdrawAddress" class="input-box" placeholder="Address">
            <button class="action-btn btn-primary" onclick="submitWithdrawal()">Request</button>
        </div>
    </div>

    <!-- BUY MODAL -->
    <div id="buyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('buyModal')">&times;</span>
            <h3>Checkout</h3>
            <p id="buyProductName"></p>
            <input type="text" id="shipAddress" class="input-box" placeholder="Address">
            <input type="text" id="shipPhone" class="input-box" placeholder="Phone">
            <button class="action-btn btn-primary" onclick="processPurchase()">Confirm</button>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="successModal" class="modal">
        <div class="modal-content" style="background: linear-gradient(135deg,#c0392b,#8e44ad); color:white;">
            <i class="fas fa-check-circle" style="font-size:3rem;"></i>
            <h2>Purchase Successful!</h2>
            <p>Tracking Code:</p>
            <div id="finalTrackingCode" style="background:rgba(0,0,0,0.3); padding:10px;"></div>
            <button class="action-btn" onclick="closeModal('successModal')">Close</button>
        </div>
    </div>

    <!-- CALL MODAL -->
    <div id="callModal" class="call-modal" style="display:none;">
        <div class="call-box">
            <div id="callAvatarContainer" class="call-avatar-container">
                <img id="callAvatarImg" class="call-avatar" src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png">
                <div id="callPulseRing" class="pulse-ring"></div>
            </div>
            <div id="callStatus" class="call-status">Connecting...</div>
            <video id="localVideo" autoplay playsinline muted style="display:none;"></video>
            <video id="remoteVideo" autoplay playsinline style="display:none;"></video>
            <div class="call-buttons">
                <button id="acceptCallBtn">Accept</button>
                <button id="rejectCallBtn">Reject</button>
                <button id="endCallBtn">End</button>
            </div>
        </div>
    </div>

    <!-- Hidden audio elements -->
    <audio id="sendMessageSound" src="https://close-plum-wlt1tch4ep.edgeone.app/floraphonic-happy-pop-1-185286.mp3" preload="auto"></audio>
    <audio id="notificationSound" src="https://obliged-beige-gdsrsmjvj7.edgeone.app/universfield-new-notification-032-480570.mp3" preload="auto"></audio>
    <audio id="errorSound" src="https://pleased-maroon-xnqs8ftowb.edgeone.app/u_31vnwfmzt6-error-126627.mp3" preload="auto"></audio>

    <script type="module">
        // ========== FIREBASE ==========
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, updateDoc, onSnapshot, orderBy, serverTimestamp, addDoc, increment, deleteDoc, writeBatch, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
        import Toastify from 'https://cdn.jsdelivr.net/npm/toastify-js/src/toastify-es.js';

        console.log("Firebase modules loaded");

        const firebaseConfig = {
            apiKey: "AIzaSyDvSEbNwMZJeE7WXrUvjclmSpeDyTjqLzw",
            authDomain: "fully-understand.firebaseapp.com",
            projectId: "fully-understand",
            storageBucket: "fully-understand.firebasestorage.app",
            messagingSenderId: "372305817292",
            appId: "1:372305817292:web:795d8def6932874df09c69"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log("Firebase initialized");

        const CLOUD_NAME = 'dnkll2fha';
        const UPLOAD_PRESET = 'my_website_design';
        const ADMIN_EMAIL = "moxxxtiox@gmail.com";
        const defaultAvatar = 'https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png';

        // ========== SOUND EFFECTS ==========
        const sendSound = document.getElementById('sendMessageSound');
        const notifSound = document.getElementById('notificationSound');
        const errorSound = document.getElementById('errorSound');

        function playSendSound() {
            sendSound.currentTime = 0;
            sendSound.play().catch(e => console.log('Send sound play failed', e));
        }
        function playNotificationSound() {
            notifSound.currentTime = 0;
            notifSound.play().catch(e => console.log('Notification sound play failed', e));
        }
        function playErrorSound() {
            errorSound.currentTime = 0;
            errorSound.play().catch(e => console.log('Error sound play failed', e));
        }

        // ========== PROFILE MUSIC VARIABLES ==========
        let profileAudio = null;
        let isProfileMusicPlaying = false;

        // ========== WALLPAPERS (now from Firestore) ==========
        let wallpapers = [];
        let selectedWallpaper = null;

        // ========== GLOBAL VARIABLES ==========
        let currentUser = null;
        let currentUserData = null;
        let currentChatId = null;
        let currentChatPartner = null;
        let chatUnsubscribe = null;
        let selectedProduct = null;
        let isCelebChat = false;
        let notificationsUnsubscribe = null;
        let unreadCount = 0;
        let recentChatsUnsubscribe = null;
        let postsUnsubscribe = null;
        let commentUnsubscribes = new Map();
        let celebrities = [];
        let adminUserData = null;
        let transactions = [];
        let transactionsUnsubscribe = null;
        let followersUnsubscribe = null;
        let followingUnsubscribe = null;
        let wallpapersUnsubscribe = null;

        // Gift store variables
        let currentPurchaseCard = null;
        let blackhawkInterval = null;

        // Follow state for popup
        let currentPopupUserId = null;
        let currentPopupUserData = null;
        let currentPopupIsCeleb = false;

        // Gift card list for store (min/max updated)
        const giftCards = [
            { name: "Visa Gift Card", icon: "fab fa-cc-visa", min: 50, max: 2000 },
            { name: "Mastercard Gift Card", icon: "fab fa-cc-mastercard", min: 50, max: 2000 },
            { name: "American Express", icon: "fab fa-cc-amex", min: 50, max: 2000 },
            { name: "Amazon Gift Card", icon: "fab fa-amazon", min: 50, max: 2000 },
            { name: "Walmart Gift Card", icon: "fas fa-store", min: 50, max: 2000 },
            { name: "Target Gift Card", icon: "fas fa-bullseye", min: 50, max: 2000 },
            { name: "eBay Gift Card", icon: "fab fa-ebay", min: 50, max: 2000 },
            { name: "Steam Gift Card", icon: "fab fa-steam", min: 50, max: 2000 },
            { name: "Google Play", icon: "fab fa-google-play", min: 50, max: 2000 },
            { name: "Apple / iTunes", icon: "fab fa-apple", min: 50, max: 2000 },
            { name: "Razer Gold", icon: "fas fa-dragon", min: 50, max: 2000 },
            { name: "PlayStation", icon: "fab fa-playstation", min: 50, max: 2000 },
            { name: "Xbox", icon: "fab fa-xbox", min: 50, max: 2000 },
            { name: "Roblox", icon: "fas fa-gamepad", min: 50, max: 2000 },
            { name: "Nintendo eShop", icon: "fas fa-gamepad", min: 50, max: 2000 },
            { name: "Starbucks", icon: "fas fa-coffee", min: 50, max: 2000 }
        ];

        // ========== UTILITY ==========
        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        function updateBalanceDisplay() {
            const bal = currentUserData?.balance || 0;
            document.getElementById('homeBalance').innerText = `$${bal.toFixed(2)}`;
            document.getElementById('walletBalance').innerText = `$${bal.toFixed(2)}`;
            document.getElementById('headerBal').innerText = `$${bal.toFixed(2)}`;
        }

        // ========== UPDATE HOME PROFILE ==========
        function updateHomeProfile() {
            if (!currentUserData) return;
            document.getElementById('homeProfileName').innerText = currentUserData.fullName || 'User';
            document.getElementById('homeProfileAvatar').src = currentUserData.avatar || defaultAvatar;
            document.getElementById('homeVipLevel').innerText = currentUserData.vipLevel || '1';
        }

        // ========== AUTH ==========
        window.toggleAuth = function(form) {
            document.getElementById('loginForm').style.display = form === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = form === 'register' ? 'block' : 'none';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        };

        window.startRegistration = async function() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPassword').value;
            if (!name || !email || !pass) {
                playErrorSound();
                return Toastify({ text: "Fill all fields" }).showToast();
            }
            document.getElementById('spinner').style.display = 'flex';
            document.getElementById('spinnerText').innerText = 'Creating account...';
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, 'users', cred.user.uid), {
                    fullName: name,
                    email,
                    balance: 0,
                    vipLevel: 1,
                    avatar: defaultAvatar,
                    wallpaper: 'static17',
                    uploadCount: 0,
                    lastUploadDate: '',
                    followers: [],
                    following: []
                });
                Toastify({ text: "Account created", backgroundColor: "green" }).showToast();
            } catch (e) {
                playErrorSound();
                Toastify({ text: e.message, backgroundColor: "#e74c3c" }).showToast();
            } finally {
                document.getElementById('spinner').style.display = 'none';
            }
        };

        window.loginUser = async function() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            if (!email || !pass) {
                playErrorSound();
                return Toastify({ text: "Enter email and password" }).showToast();
            }
            document.getElementById('spinner').style.display = 'flex';
            document.getElementById('spinnerText').innerText = 'Logging in...';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                playErrorSound();
                Toastify({ text: e.message, backgroundColor: "#e74c3c" }).showToast();
            } finally {
                document.getElementById('spinner').style.display = 'none';
            }
        };

        window.logout = () => signOut(auth);

        // ========== WALLPAPER FUNCTIONS ==========
        function loadWallpapers() {
            if (wallpapersUnsubscribe) wallpapersUnsubscribe();
            const q = query(collection(db, 'wallpapers'));
            wallpapersUnsubscribe = onSnapshot(q, (snap) => {
                wallpapers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (wallpapers.length === 0) {
                    wallpapers = [{ id: 'static17', name: 'Default', url: 'https://res.cloudinary.com/dnkll2fha/image/upload/f_auto,q_auto,w_800/v1/wallpapers/static17', moving: false }];
                }
                selectedWallpaper = wallpapers.find(w => w.id === (currentUserData?.wallpaper || 'static17')) || wallpapers[0];
                renderWallpaperGrid();
            });
        }

        function renderWallpaperGrid() {
            const grid = document.getElementById('wallpaperGrid');
            if (!grid) return;
            grid.innerHTML = wallpapers.map(w => {
                const isSelected = selectedWallpaper && selectedWallpaper.id === w.id;
                return `
                    <div class="wallpaper-item ${isSelected ? 'selected' : ''} ${w.moving ? 'moving' : ''}" 
                         onclick="selectWallpaper('${w.id}')"
                         style="background-image: url('${w.moving ? '' : w.url}'); background-color: ${w.moving ? '#2a3942' : 'transparent'};">
                        ${w.moving ? '<i class="fas fa-video" style="font-size:2rem; color:#8e44ad;"></i>' : ''}
                        <span class="preview-label">${w.name}</span>
                    </div>
                `;
            }).join('');
        }

        window.selectWallpaper = function(id) {
            selectedWallpaper = wallpapers.find(w => w.id === id) || wallpapers[0];
            renderWallpaperGrid();
        };

        window.openWallpaperModal = function() {
            document.getElementById('settingsMenu').classList.remove('active');
            renderWallpaperGrid();
            document.getElementById('wallpaperModal').style.display = 'flex';
            document.getElementById('wallpaperStatus').textContent = '';
        };

        window.saveWallpaper = async function() {
            const status = document.getElementById('wallpaperStatus');
            status.textContent = 'Saving...';
            status.style.color = '#8e44ad';
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { wallpaper: selectedWallpaper.id });
                currentUserData.wallpaper = selectedWallpaper.id;
                document.getElementById('wallpaperModal').style.display = 'none';
                Toastify({ text: "Wallpaper updated!" }).showToast();
            } catch (e) {
                playErrorSound();
                status.textContent = 'Error: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        };

        function applyChatWallpaper() {
            const videoEl = document.getElementById('chatVideo');
            const imageEl = document.getElementById('chatImageBg');
            if (!videoEl || !imageEl) return;
            const wallpaperId = currentUserData?.wallpaper || 'static17';
            const wallpaper = wallpapers.find(w => w.id === wallpaperId) || wallpapers[0];
            
            if (wallpaper?.moving) {
                videoEl.style.display = 'block';
                imageEl.style.display = 'none';
                videoEl.src = wallpaper.url;
                videoEl.load();
                videoEl.play().catch(e => console.log('Video play error', e));
            } else {
                videoEl.style.display = 'none';
                videoEl.pause();
                imageEl.style.display = 'block';
                imageEl.style.backgroundImage = `url('${wallpaper?.url}')`;
                imageEl.classList.add('moving');
            }
        }

        // ========== SETTINGS MENU ==========
        window.toggleSettingsMenu = function() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        };

        document.addEventListener('click', function(event) {
            const menu = document.getElementById('settingsMenu');
            const icon = document.querySelector('.settings-icon');
            if (menu && icon && !menu.contains(event.target) && !icon.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // ========== CHANGE NAME ==========
        window.openChangeNameModal = function() {
            document.getElementById('settingsMenu').classList.remove('active');
            document.getElementById('changeNameModal').style.display = 'flex';
            document.getElementById('newNameInput').value = currentUserData?.fullName || '';
            document.getElementById('nameUpdateStatus').textContent = '';
        };

        window.updateDisplayName = async function() {
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) {
                playErrorSound();
                document.getElementById('nameUpdateStatus').textContent = 'Please enter a name';
                document.getElementById('nameUpdateStatus').style.color = '#ff6b6b';
                return;
            }
            const status = document.getElementById('nameUpdateStatus');
            status.textContent = 'Updating...';
            status.style.color = '#8e44ad';
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { fullName: newName });
                currentUserData.fullName = newName;
                document.getElementById('profileName').textContent = newName;
                document.getElementById('homeProfileName').innerText = newName;
                document.getElementById('changeNameModal').style.display = 'none';
                Toastify({ text: "Name updated successfully!", backgroundColor: "green" }).showToast();
            } catch (e) {
                playErrorSound();
                status.textContent = 'Error: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        };

        // ========== NOTIFICATIONS ==========
        function loadNotifications() {
            if (!currentUser) return;
            if (notificationsUnsubscribe) notificationsUnsubscribe();

            const q = query(
                collection(db, 'notifications'),
                where('userId', '==', currentUser.uid)
            );

            notificationsUnsubscribe = onSnapshot(q, (snap) => {
                const notifs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                notifs.sort((a, b) => (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0));
                unreadCount = notifs.filter(n => !n.read).length;
                updateNotificationUI(notifs);
            }, (error) => {
                console.error('Notifications listener error:', error);
            });
        }

        function updateNotificationUI(notifs) {
            const badge = document.getElementById('notificationBadge');
            const bell = document.getElementById('bellIcon');
            const cnt = document.getElementById('notificationCount');
            badge.style.display = unreadCount ? 'flex' : 'none';
            badge.textContent = unreadCount;
            if (unreadCount > 0) bell.classList.add('has-notifications');
            else bell.classList.remove('has-notifications');
            cnt.innerText = unreadCount + ' new';
            const list = document.getElementById('notificationList');
            if (!notifs.length) {
                list.innerHTML = '<div class="notification-empty">No notifications</div>';
                return;
            }
            list.innerHTML = notifs.map(n => {
                const title = n.title || 'Notification';
                const message = n.message || '';
                const from = n.from || 'System';
                const avatar = n.avatar || defaultAvatar;
                const time = n.timestamp ? formatTimeAgo(n.timestamp) : '';
                const link = n.link || '';
                return `
                    <div class="notification-item ${n.read ? '' : 'unread'}" onclick="openNotification('${n.id}', '${link}')">
                        <img src="${avatar}" class="notification-avatar" onerror="this.src='${defaultAvatar}'">
                        <div class="notification-content">
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                            <div class="notification-time">${time} â€¢ From: ${from}</div>
                        </div>
                    </div>
                `;
            }).join('');
            if (unreadCount > 0) {
                playNotificationSound();
            }
        }

        window.openNotification = async (id, link) => {
            await updateDoc(doc(db, 'notifications', id), { read: true });
            document.getElementById('notificationDropdown').classList.remove('active');
            if (link) {
                const parts = link.split('|');
                if (parts[0] === 'celeb') {
                    openCelebChat(parts[1], parts[2]);
                } else if (parts[0] === 'user') {
                    openUserChat(parts[1], parts[2], parts[3]);
                }
            }
        };

        window.markAllAsRead = async () => {
            const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid), where('read', '==', false));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.docs.forEach(d => batch.update(d.ref, { read: true }));
            await batch.commit();
        };

        window.clearAllNotifications = async () => {
            if (!confirm('Delete all notifications?')) return;
            const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        window.toggleNotificationDropdown = () => {
            const d = document.getElementById('notificationDropdown');
            d.classList.toggle('active');
        };

        document.getElementById('bellIcon').addEventListener('click', toggleNotificationDropdown);

        // ========== RECENT CHATS ==========
        function loadRecentChats() {
            if (!currentUser) return;
            if (recentChatsUnsubscribe) recentChatsUnsubscribe();
            const q = query(
                collection(db, 'userChats', currentUser.uid, 'chats'),
                orderBy('lastTimestamp', 'desc')
            );
            recentChatsUnsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('recentChatsList');
                if (!list) return;
                if (snapshot.empty) {
                    list.innerHTML = '<div class="notification-empty"><i class="fas fa-comments"></i><p>No recent chats</p></div>';
                    return;
                }
                let html = '';
                snapshot.forEach(docSnap => {
                    const chat = docSnap.data();
                    const chatId = docSnap.id;
                    const unread = chat.unreadCount || 0;
                    const timeAgo = formatTimeAgo(chat.lastTimestamp);
                    const lastMsg = chat.lastMessage || 'Tap to start chatting';
                    const verifiedIcon = chat.isCeleb ? '<i class="fas fa-check-circle verified-badge"></i>' : '';
                    html += `
                        <div class="recent-chat-item" onclick="openChatFromRecent('${chatId}', '${chat.partnerName}', '${chat.partnerAvatar}', ${chat.isCeleb}, '${chat.partnerId}')">
                            <img src="${chat.partnerAvatar}" class="recent-chat-avatar" onerror="this.src='${defaultAvatar}'">
                            <div class="recent-chat-info">
                                <div class="recent-chat-name">
                                    ${chat.partnerName}
                                    ${verifiedIcon}
                                </div>
                                <div class="recent-chat-message">${lastMsg}</div>
                                <div class="recent-chat-time">${timeAgo}</div>
                            </div>
                            ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
                        </div>
                    `;
                });
                list.innerHTML = html;
            }, (error) => {
                console.error('Recent chats listener error:', error);
            });
        }

        window.openChatFromRecent = function(chatId, name, avatar, isCeleb, partnerId) {
            updateDoc(doc(db, 'userChats', currentUser.uid, 'chats', chatId), { unreadCount: 0 });
            if (isCeleb) {
                openCelebChat(name, avatar);
            } else {
                openUserChat(name, avatar, partnerId);
            }
        };

        // ========== LOAD CELEBRITIES FROM FIRESTORE ==========
        async function loadCelebrities() {
            const q = query(collection(db, 'celebrities'));
            const snap = await getDocs(q);
            celebrities = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCelebs();
        }

        // ========== ADMIN ADD CELEBRITY ==========
        window.addCelebrity = async function() {
            const name = document.getElementById('newCelebName').value.trim();
            const img = document.getElementById('newCelebImg').value.trim();
            if (!name || !img) {
                playErrorSound();
                return Toastify({ text: "Enter name and image URL" }).showToast();
            }
            await addDoc(collection(db, 'celebrities'), { name, img });
            document.getElementById('newCelebName').value = '';
            document.getElementById('newCelebImg').value = '';
            loadCelebrities();
            Toastify({ text: "Celebrity added" }).showToast();
        };

        function renderCelebs() {
            const grid = document.getElementById('allCelebGrid');
            const home = document.getElementById('homeCelebList');
            if (!grid || !home) return;
            
            grid.innerHTML = celebrities.map(c => `
                <div class="celeb-card" onclick="openCelebPopup('${c.id}', '${c.name}', '${c.img}')">
                    <img src="${c.img}" class="celeb-img" onerror="this.src='${defaultAvatar}'">
                    <div class="celeb-name">${c.name} <i class="fas fa-check-circle verified-badge"></i></div>
                </div>
            `).join('');
            
            home.innerHTML = celebrities.slice(0, 8).map(c => `
                <div class="celeb-card" onclick="openCelebChat('${c.name}', '${c.img}')">
                    <img src="${c.img}" class="celeb-img" onerror="this.src='${defaultAvatar}'">
                    <div class="celeb-name">${c.name} <i class="fas fa-check-circle verified-badge"></i></div>
                </div>
            `).join('');
        }

        // ========== CELEBRITY POPUP (follow counts editable later by admin) ==========
        window.openCelebPopup = (celebId, name, avatar) => {
            currentPopupUserId = celebId;
            currentPopupIsCeleb = true;
            document.getElementById('popupAvatar').src = avatar || defaultAvatar;
            document.getElementById('popupName').innerText = name;
            document.getElementById('popupVip').innerHTML = 'Celebrity';
            document.getElementById('popupFollowers').innerText = '0'; // Placeholder, admin can update later
            document.getElementById('popupFollowing').innerText = '0';
            const btn = document.getElementById('popupFollowBtn');
            btn.innerText = 'Follow'; // Placeholder, actual follow not implemented for celebs yet
            btn.style.display = 'none'; // Hide follow for now, can be enabled later
            document.getElementById('userPopupModal').style.display = 'flex';
        };

        // ========== USERS (Find Friends) ==========
        function loadUsers() {
            const q = query(collection(db, 'users'));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('userList');
                if (!list) return;
                
                if (snap.empty) {
                    list.innerHTML = '<div class="notification-empty">No users found</div>';
                    return;
                }
                
                list.innerHTML = snap.docs
                    .filter(d => d.id !== currentUser.uid)
                    .map(d => {
                        const u = d.data();
                        const isFollowing = currentUserData?.following?.includes(d.id);
                        return `
                            <div class="friend-card" onclick="openUserPopup('${d.id}', '${u.fullName}', '${u.avatar}', ${u.vipLevel || 1}, ${u.followers?.length || 0}, ${u.following?.length || 0})">
                                <img src="${u.avatar || defaultAvatar}" class="friend-avatar" onerror="this.src='${defaultAvatar}'">
                                <div class="friend-info">
                                    <div class="friend-name">${u.fullName}</div>
                                    <div class="friend-vip">VIP ${u.vipLevel || 1}</div>
                                </div>
                                <button class="follow-btn ${isFollowing ? 'following' : ''}" onclick="event.stopPropagation(); toggleFollow('${d.id}', this)">${isFollowing ? 'Following' : 'Follow'}</button>
                            </div>
                        `;
                    }).join('');
            }, (error) => {
                console.error('Users listener error:', error);
            });
        }

        // ========== FOLLOW SYSTEM ==========
        window.toggleFollow = async (targetUserId, btn) => {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            const targetRef = doc(db, 'users', targetUserId);
            
            const isFollowing = currentUserData.following?.includes(targetUserId);
            
            if (isFollowing) {
                await updateDoc(userRef, {
                    following: arrayRemove(targetUserId)
                });
                await updateDoc(targetRef, {
                    followers: arrayRemove(currentUser.uid)
                });
                currentUserData.following = currentUserData.following?.filter(id => id !== targetUserId) || [];
                btn.innerText = 'Follow';
                btn.classList.remove('following');
            } else {
                await updateDoc(userRef, {
                    following: arrayUnion(targetUserId)
                });
                await updateDoc(targetRef, {
                    followers: arrayUnion(currentUser.uid)
                });
                currentUserData.following = [...(currentUserData.following || []), targetUserId];
                btn.innerText = 'Following';
                btn.classList.add('following');
            }
        };

        // Load followers/following for current user
        function loadFollowStats() {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, (doc) => {
                const data = doc.data();
                document.getElementById('profileFollowers').innerText = data.followers?.length || 0;
                document.getElementById('profileFollowing').innerText = data.following?.length || 0;
            });
        }

        // User popup
        window.openUserPopup = (userId, name, avatar, vip, followers, following) => {
            currentPopupUserId = userId;
            currentPopupIsCeleb = false;
            currentPopupUserData = { name, avatar, vip, followers, following };
            document.getElementById('popupAvatar').src = avatar || defaultAvatar;
            document.getElementById('popupName').innerText = name;
            document.getElementById('popupVip').innerHTML = `VIP ${vip}`;
            document.getElementById('popupFollowers').innerText = followers;
            document.getElementById('popupFollowing').innerText = following;
            const isFollowing = currentUserData.following?.includes(userId);
            const btn = document.getElementById('popupFollowBtn');
            btn.innerText = isFollowing ? 'Following' : 'Follow';
            btn.classList.toggle('following', isFollowing);
            btn.style.display = 'inline-block';
            document.getElementById('userPopupModal').style.display = 'flex';
        };

        window.toggleFollowFromPopup = async () => {
            if (currentPopupIsCeleb) return;
            const btn = document.getElementById('popupFollowBtn');
            await toggleFollow(currentPopupUserId, btn);
            const newFollowing = btn.innerText === 'Following';
            const followers = parseInt(document.getElementById('popupFollowers').innerText);
            document.getElementById('popupFollowers').innerText = newFollowing ? followers + 1 : followers - 1;
        };

        window.openUserChatFromPopup = () => {
            if (currentPopupIsCeleb) {
                openCelebChat(currentPopupUserData?.name || document.getElementById('popupName').innerText, document.getElementById('popupAvatar').src);
            } else {
                openUserChat(currentPopupUserData?.name || document.getElementById('popupName').innerText, document.getElementById('popupAvatar').src, currentPopupUserId);
            }
            closeUserPopup();
        };

        window.closeUserPopup = () => {
            document.getElementById('userPopupModal').style.display = 'none';
            currentPopupUserId = null;
            currentPopupUserData = null;
            currentPopupIsCeleb = false;
        };

        // ========== CHAT OPENERS ==========
        window.openCelebChat = function(name, avatar) {
            isCelebChat = true;
            const privateChatId = `celeb_${name.replace(/[^a-zA-Z0-9]/g, '_')}_${currentUser.uid}`;
            openChat(name, avatar, null, true, privateChatId);
        };

        window.openUserChat = function(name, avatar, uid) {
            isCelebChat = false;
            openChat(name, avatar, uid, false, null);
        };

        function openChat(name, avatar, uid, isCeleb, predefinedChatId = null) {
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            document.getElementById('messageContainer').innerHTML = '';
            document.getElementById('msgInput').value = '';

            document.getElementById('chatName').innerText = name;
            document.getElementById('chatAvatar').src = avatar;

            const verifiedIcon = document.getElementById('chatVerifiedIcon');
            if (verifiedIcon) {
                verifiedIcon.style.display = isCeleb ? 'inline-block' : 'none';
            }

            document.getElementById('chatInterface').style.display = 'flex';
            applyChatWallpaper();

            if (isCeleb) {
                currentChatId = predefinedChatId || `celeb_${name.replace(/[^a-zA-Z0-9]/g, '_')}_${currentUser.uid}`;
                currentChatPartner = { name, avatar, isCeleb: true, partnerId: name };
                document.getElementById('callButtons').style.display = 'none';
            } else {
                currentChatId = [currentUser.uid, uid].sort().join('_');
                currentChatPartner = { name, avatar, uid, isCeleb: false, partnerId: uid };
                document.getElementById('callButtons').style.display = 'flex';
                document.getElementById('audioCallBtn').onclick = () => startCall('audio', uid, name, avatar);
                document.getElementById('videoCallBtn').onclick = () => startCall('video', uid, name, avatar);
            }

            setDoc(doc(db, 'userChats', currentUser.uid, 'chats', currentChatId), {
                partnerName: name,
                partnerAvatar: avatar,
                partnerId: isCeleb ? name : uid,
                isCeleb: isCeleb,
                lastTimestamp: Date.now(),
            }, { merge: true }).catch(err => {
                console.error('Error creating recent chat:', err);
            });

            updateDoc(doc(db, 'userChats', currentUser.uid, 'chats', currentChatId), { unreadCount: 0 }).catch(() => {});

            const q = query(collection(db, 'chats', currentChatId, 'messages'), orderBy('timestamp'));
            chatUnsubscribe = onSnapshot(q, (snap) => {
                const cont = document.getElementById('messageContainer');
                cont.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const isSent = m.sender === currentUser.uid;
                    return `<div class="message ${isSent ? 'sent' : 'received'}">${m.text}<span class="message-time">${formatTimeAgo(m.timestamp)}</span></div>`;
                }).join('');
                cont.scrollTop = cont.scrollHeight;
            }, (error) => {
                console.error('Chat messages listener error:', error);
            });
        }

        window.sendMessage = async function() {
            const inp = document.getElementById('msgInput');
            if (!inp.value.trim() || !currentChatId) return;
            const txt = inp.value.trim();

            await addDoc(collection(db, 'chats', currentChatId, 'messages'), {
                sender: currentUser.uid,
                text: txt,
                timestamp: serverTimestamp()
            });

            await setDoc(doc(db, 'userChats', currentUser.uid, 'chats', currentChatId), {
                partnerName: currentChatPartner.name,
                partnerAvatar: currentChatPartner.avatar,
                partnerId: currentChatPartner.isCeleb ? currentChatPartner.name : currentChatPartner.uid,
                isCeleb: currentChatPartner.isCeleb,
                lastMessage: txt,
                lastTimestamp: Date.now(),
                unreadCount: 0
            }, { merge: true });

            if (!currentChatPartner.isCeleb && currentChatPartner.uid) {
                const otherChatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
                await setDoc(doc(db, 'userChats', currentChatPartner.uid, 'chats', otherChatId), {
                    partnerName: currentUserData.fullName,
                    partnerAvatar: currentUserData.avatar,
                    partnerId: currentUser.uid,
                    isCeleb: false,
                    lastMessage: txt,
                    lastTimestamp: Date.now(),
                    unreadCount: increment(1)
                }, { merge: true });

                await addDoc(collection(db, 'notifications'), {
                    userId: currentChatPartner.uid,
                    type: 'message',
                    title: 'New Message',
                    message: txt,
                    from: currentUserData?.fullName || 'Someone',
                    avatar: currentUserData?.avatar || defaultAvatar,
                    timestamp: serverTimestamp(),
                    read: false,
                    link: `user|${currentUserData?.fullName || 'User'}|${currentUserData?.avatar || defaultAvatar}|${currentUser.uid}`
                });
            }

            if (currentChatPartner.isCeleb) {
                await addDoc(collection(db, 'adminMessages'), {
                    userId: currentUser.uid,
                    userName: currentUserData?.fullName || 'User',
                    userAvatar: currentUserData?.avatar || defaultAvatar,
                    celebrity: currentChatPartner.name,
                    message: txt,
                    timestamp: serverTimestamp(),
                    read: false,
                    fromAdmin: false,
                    chatId: currentChatId
                });
            }

            inp.value = '';
            inp.blur();
            playSendSound();
        };

        window.closeChat = function() {
            document.getElementById('chatInterface').style.display = 'none';
            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }
            currentChatId = null;
            currentChatPartner = null;
            const video = document.getElementById('chatVideo');
            if (video) video.pause();
        };

        // ========== MARKETPLACE ==========
        window.openBuyModal = (name, price) => {
            selectedProduct = { name, price };
            document.getElementById('buyProductName').innerText = name + ' - $' + price;
            document.getElementById('buyModal').style.display = 'flex';
        };
        window.processPurchase = async () => {
            const addr = document.getElementById('shipAddress').value;
            const phone = document.getElementById('shipPhone').value;
            if (!addr || !phone) {
                playErrorSound();
                return Toastify({ text: "Fill all fields" }).showToast();
            }
            if (currentUserData.balance < selectedProduct.price) {
                playErrorSound();
                Toastify({ text: "Insufficient funds" }).showToast(); return;
            }
            document.getElementById('buyModal').style.display = 'none';
            document.getElementById('spinner').style.display = 'flex';
            document.getElementById('spinnerText').innerText = 'Processing purchase...';
            const track = 'TRK-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(-selectedProduct.price) });
            currentUserData.balance -= selectedProduct.price;
            updateBalanceDisplay();
            await addDoc(collection(db, 'orders'), {
                userId: currentUser.uid,
                product: selectedProduct.name,
                price: selectedProduct.price,
                address: addr,
                phone,
                trackingCode: track,
                status: 'Processing'
            });
            await addTransaction({
                type: 'purchase',
                amount: selectedProduct.price,
                status: 'completed',
                details: `Purchased ${selectedProduct.name}`
            });
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('finalTrackingCode').innerText = track;
            document.getElementById('successModal').style.display = 'flex';
        };

        window.attemptWithdrawal = () => {
            if ((currentUserData.vipLevel || 1) < 4) {
                playErrorSound();
                Toastify({ text: "VIP 4 required" }).showToast();
                return;
            }
            document.getElementById('withdrawModal').style.display = 'flex';
        };
        window.submitWithdrawal = async () => {
            const amt = parseFloat(document.getElementById('withdrawAmount').value);
            const addr = document.getElementById('withdrawAddress').value;
            if (!amt || amt < 1 || !addr) {
                playErrorSound();
                return Toastify({ text: "Invalid amount or address" }).showToast();
            }
            if (amt > currentUserData.balance) {
                playErrorSound();
                return Toastify({ text: "Insufficient balance" }).showToast();
            }
            await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(-amt) });
            currentUserData.balance -= amt;
            updateBalanceDisplay();
            await addDoc(collection(db, 'withdrawals'), { userId: currentUser.uid, amount: amt, address: addr, timestamp: Date.now(), status: 'pending' });
            await addTransaction({
                type: 'withdrawal',
                amount: amt,
                status: 'pending',
                details: `Withdrawal request to ${addr}`
            });
            document.getElementById('withdrawModal').style.display = 'none';
            Toastify({ text: "Withdrawal requested" }).showToast();
        };

        window.openDepositModal = () => {
            document.getElementById('depositModal').style.display = 'flex';
            selectDepositMethod('crypto');
        };
        window.copyAddress = (text) => {
            navigator.clipboard.writeText(text);
            Toastify({ text: "Address copied" }).showToast();
        };
        window.copyToClipboard = copyAddress;

        // ========== DEPOSIT METHOD SELECTOR ==========
        window.selectDepositMethod = (method) => {
            const cryptoSection = document.getElementById('cryptoDepositSection');
            const giftSection = document.getElementById('giftDepositSection');
            const btns = document.querySelectorAll('.method-btn');
            btns.forEach(btn => btn.classList.remove('active'));
            if (method === 'crypto') {
                btns[0].classList.add('active');
                cryptoSection.style.display = 'block';
                giftSection.style.display = 'none';
            } else {
                btns[1].classList.add('active');
                cryptoSection.style.display = 'none';
                giftSection.style.display = 'block';
            }
        };

        // ========== REDEEM GIFT CARD ==========
        window.openRedeemModal = (cardType) => {
            if (cardType) {
                document.getElementById('redeemCardType').value = cardType;
            }
            document.getElementById('redeemModal').style.display = 'flex';
        };

        window.submitRedeemRequest = async () => {
            const cardType = document.getElementById('redeemCardType').value;
            const code = document.getElementById('redeemCode').value.trim();
            const amount = parseFloat(document.getElementById('redeemAmount').value);
            const statusDiv = document.getElementById('redeemStatus');

            if (!cardType || !code || !amount) {
                statusDiv.innerHTML = '<span class="error-message">Please fill all fields</span>';
                return;
            }
            if (code.length !== 16) {
                statusDiv.innerHTML = '<span class="error-message">Code must be 16 digits</span>';
                return;
            }

            statusDiv.innerHTML = '<span class="warning-message">Submitting for verification...</span>';
            document.getElementById('redeemSubmitBtn').disabled = true;

            try {
                await addDoc(collection(db, 'giftCardRedemptions'), {
                    userId: currentUser.uid,
                    userName: currentUserData.fullName,
                    cardType,
                    code,
                    amount,
                    timestamp: serverTimestamp(),
                    status: 'pending'
                });

                await addTransaction({
                    type: 'gift_redeem',
                    amount: amount,
                    status: 'pending',
                    details: `Redeemed ${cardType} gift card`
                });

                statusDiv.innerHTML = '<span class="success-message">âœ… Gift card submitted for verification. Funds will be added once confirmed.</span>';
                setTimeout(() => {
                    closeModal('redeemModal');
                    document.getElementById('redeemCardType').value = '';
                    document.getElementById('redeemCode').value = '';
                    document.getElementById('redeemAmount').value = '';
                }, 2000);
            } catch (e) {
                console.error('Redeem error:', e);
                statusDiv.innerHTML = '<span class="error-message">Error submitting request</span>';
            } finally {
                document.getElementById('redeemSubmitBtn').disabled = false;
            }
        };

        // ========== GIFT STORE ==========
        window.openGiftStoreWithSpinner = () => {
            const modal = document.getElementById('giftStoreModal');
            const spinner = document.getElementById('giftStoreSpinner');
            const content = document.getElementById('giftStoreContent');
            
            modal.style.display = 'flex';
            spinner.style.display = 'flex';
            content.style.display = 'none';

            setTimeout(() => {
                spinner.style.display = 'none';
                content.style.display = 'block';
                renderGiftStore();
                startBlackhawkPopup();
            }, 16000);
        };

        window.clearBlackhawkInterval = () => {
            if (blackhawkInterval) {
                clearInterval(blackhawkInterval);
                blackhawkInterval = null;
            }
        };

        function renderGiftStore() {
            const grid = document.getElementById('giftStoreGrid');
            if (!grid) return;
            grid.innerHTML = giftCards.map(card => `
                <div class="store-item" onclick="openGiftPurchase('${card.name}', '${card.icon}')">
                    <i class="${card.icon}"></i>
                    <div class="name">${card.name}</div>
                    <div class="price">$${card.min} - $${card.max}</div>
                </div>
            `).join('');
        }

        window.filterGiftStore = () => {
            const search = document.getElementById('giftStoreSearch').value.toLowerCase();
            const items = document.querySelectorAll('.store-item');
            items.forEach(item => {
                const name = item.querySelector('.name').innerText.toLowerCase();
                item.style.display = name.includes(search) ? 'block' : 'none';
            });
        };

        window.openGiftPurchase = (cardName, iconClass) => {
            currentPurchaseCard = { name: cardName, icon: iconClass };
            document.getElementById('purchaseCardTitle').innerText = `Purchase ${cardName}`;
            document.getElementById('purchaseCardIcon').className = iconClass;
            document.getElementById('purchaseBalance').innerText = `$${currentUserData.balance.toFixed(2)}`;
            document.getElementById('purchaseAmount').value = '';
            document.getElementById('purchaseError').style.display = 'none';
            document.getElementById('purchaseStatus').innerHTML = '';
            document.getElementById('giftPurchaseModal').style.display = 'flex';
        };

        window.processGiftPurchase = async () => {
            const amount = parseFloat(document.getElementById('purchaseAmount').value);
            const errorDiv = document.getElementById('purchaseError');
            const statusDiv = document.getElementById('purchaseStatus');
            const btn = document.getElementById('purchaseBtn');

            if (!amount || amount < 50 || amount > 2000) {
                errorDiv.innerText = 'Please enter an amount between $50 and $2000';
                errorDiv.style.display = 'block';
                return;
            }
            if (amount > currentUserData.balance) {
                errorDiv.innerText = 'Insufficient funds';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            statusDiv.innerHTML = '<span class="warning-message">Processing...</span>';
            btn.disabled = true;

            const spins = [15, 12, 8];
            const spinTime = spins[Math.floor(Math.random() * spins.length)];
            const spinClass = spinTime === 15 ? 'spin-slow' : spinTime === 12 ? 'spin-medium' : 'spin-fast';
            btn.classList.add(spinClass);

            setTimeout(async () => {
                try {
                    const code = generateGiftCode();
                    
                    await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(-amount) });
                    currentUserData.balance -= amount;
                    updateBalanceDisplay();

                    await addDoc(collection(db, 'giftCardPurchases'), {
                        userId: currentUser.uid,
                        userName: currentUserData.fullName,
                        cardType: currentPurchaseCard.name,
                        amount,
                        code,
                        timestamp: serverTimestamp()
                    });

                    await addTransaction({
                        type: 'gift_purchase',
                        amount: -amount,
                        status: 'completed',
                        details: `Purchased ${currentPurchaseCard.name} gift card`
                    });

                    document.getElementById('purchasedCode').innerText = code;
                    document.getElementById('giftPurchaseModal').style.display = 'none';
                    document.getElementById('purchaseResultModal').style.display = 'flex';

                } catch (e) {
                    console.error('Purchase error:', e);
                    statusDiv.innerHTML = '<span class="error-message">Error processing purchase</span>';
                } finally {
                    btn.disabled = false;
                    btn.classList.remove(spinClass);
                    statusDiv.innerHTML = '';
                }
            }, spinTime * 1000);
        };

        function generateGiftCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    code += chars[Math.floor(Math.random() * chars.length)];
                }
                if (i < 3) code += ' ';
            }
            return code;
        }

        function startBlackhawkPopup() {
            if (blackhawkInterval) clearInterval(blackhawkInterval);
            showBlackhawkPopup();
            blackhawkInterval = setInterval(() => {
                const modal = document.getElementById('giftStoreModal');
                const content = document.getElementById('giftStoreContent');
                if (modal.style.display === 'flex' && content.style.display === 'block') {
                    showBlackhawkPopup();
                }
            }, 5 * 60 * 1000);
        }

        function showBlackhawkPopup() {
            const popup = document.getElementById('blackhawkPopup');
            popup.style.display = 'block';
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        // ========== SEND GIFT (unchanged, 1-200) ==========
        window.openSendGiftModal = () => {
            if (!currentChatPartner) {
                Toastify({ text: "No chat selected", backgroundColor: "#e74c3c" }).showToast();
                return;
            }
            document.getElementById('sendGiftAvatar').src = currentChatPartner.avatar;
            document.getElementById('sendGiftName').innerText = currentChatPartner.name;
            document.getElementById('sendGiftType').innerText = currentChatPartner.isCeleb ? 'Celebrity' : 'User';
            document.getElementById('sendGiftBalance').innerText = `$${currentUserData.balance.toFixed(2)}`;
            document.getElementById('sendGiftAmount').value = '';
            document.getElementById('sendGiftError').style.display = 'none';
            document.getElementById('sendGiftModal').style.display = 'flex';
        };

        window.processSendGift = async () => {
            const giftType = document.getElementById('sendGiftType').value;
            const amount = parseFloat(document.getElementById('sendGiftAmount').value);
            const errorDiv = document.getElementById('sendGiftError');
            const btn = document.getElementById('sendGiftBtn');

            if (!giftType) {
                errorDiv.innerText = 'Please select a gift type';
                errorDiv.style.display = 'block';
                return;
            }
            if (!amount || amount < 1 || amount > 200) {
                errorDiv.innerText = 'Please enter an amount between $1 and $200';
                errorDiv.style.display = 'block';
                return;
            }
            if (amount > currentUserData.balance) {
                errorDiv.innerText = 'Insufficient funds';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';
            btn.disabled = true;
            btn.innerHTML = 'Sending...';

            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(-amount) });
                currentUserData.balance -= amount;
                updateBalanceDisplay();

                if (!currentChatPartner.isCeleb && currentChatPartner.uid) {
                    await updateDoc(doc(db, 'users', currentChatPartner.uid), { balance: increment(amount) });
                }

                await addDoc(collection(db, 'gifts'), {
                    fromUserId: currentUser.uid,
                    fromUserName: currentUserData.fullName,
                    toUserId: currentChatPartner.isCeleb ? currentChatPartner.name : currentChatPartner.uid,
                    toUserName: currentChatPartner.name,
                    giftType,
                    amount,
                    timestamp: serverTimestamp()
                });

                await addTransaction({
                    type: 'gift_sent',
                    amount: -amount,
                    status: 'completed',
                    details: `Sent ${giftType} to ${currentChatPartner.name}`
                });

                await addDoc(collection(db, 'chats', currentChatId, 'messages'), {
                    sender: currentUser.uid,
                    text: `ðŸŽ Sent a ${giftType} worth $${amount}!`,
                    timestamp: serverTimestamp(),
                    isGift: true
                });

                Toastify({ text: `Gift sent to ${currentChatPartner.name}!`, backgroundColor: "green" }).showToast();
                closeModal('sendGiftModal');
            } catch (e) {
                console.error('Send gift error:', e);
                errorDiv.innerText = 'Error sending gift';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Send Gift';
            }
        };

        // ========== POSTS with Facebook-style video ==========
        const uploadPostBtn = document.getElementById('uploadPostBtn');
        const postUploadModal = document.getElementById('postUploadModal');
        const postCaption = document.getElementById('postCaption');
        const postFile = document.getElementById('postFile');
        const postUploadStatus = document.getElementById('postUploadStatus');
        const postsFeed = document.getElementById('postsFeed');
        let postVideosObserver = null;

        async function checkUploadLimit() {
            if (!currentUserData) return { allowed: false, reason: 'Not logged in' };
            const vip = currentUserData.vipLevel || 1;
            if (vip >= 4) return { allowed: true, unlimited: true };
            const today = new Date().toDateString();
            const lastUpload = currentUserData.lastUploadDate || '';
            const count = currentUserData.uploadCount || 0;
            if (lastUpload !== today) {
                return { allowed: true, count: 0 };
            }
            if (count >= 2) {
                return { allowed: false, reason: 'Daily limit reached (max 2). Upgrade to VIP 4 for unlimited.' };
            }
            return { allowed: true, count };
        }

        async function updateUploadButton() {
            const limit = await checkUploadLimit();
            if (limit.allowed) {
                uploadPostBtn.classList.remove('limited');
                uploadPostBtn.disabled = false;
            } else {
                uploadPostBtn.classList.add('limited');
                uploadPostBtn.disabled = true;
            }
        }

        uploadPostBtn.addEventListener('click', async () => {
            const limit = await checkUploadLimit();
            if (!limit.allowed) {
                playErrorSound();
                Toastify({ text: limit.reason, backgroundColor: '#e74c3c' }).showToast();
                return;
            }
            postUploadModal.style.display = 'flex';
            postCaption.value = '';
            postFile.value = '';
            postUploadStatus.textContent = '';
        });

        window.uploadPost = async function() {
            const file = postFile.files[0];
            const caption = postCaption.value.trim();
            if (!file) {
                postUploadStatus.textContent = 'Please select a file';
                return;
            }
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                postUploadStatus.textContent = 'Only images and videos allowed';
                return;
            }
            if (file.type.startsWith('video/') && file.size > 40 * 1024 * 1024) {
                playErrorSound();
                postUploadStatus.textContent = 'Video too large (max 40MB)';
                return;
            }
            postUploadStatus.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || 'Upload failed');

                const mediaUrl = data.secure_url;
                const mediaType = file.type.startsWith('image/') ? 'image' : 'video';

                const today = new Date().toDateString();
                const vip = currentUserData.vipLevel || 1;
                let newCount = 1;
                if (vip < 4) {
                    const lastDate = currentUserData.lastUploadDate;
                    const oldCount = currentUserData.uploadCount || 0;
                    if (lastDate === today) {
                        newCount = oldCount + 1;
                    } else {
                        newCount = 1;
                    }
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        lastUploadDate: today,
                        uploadCount: newCount
                    });
                    currentUserData.lastUploadDate = today;
                    currentUserData.uploadCount = newCount;
                }

                await addDoc(collection(db, 'posts'), {
                    userId: currentUser.uid,
                    userName: currentUserData.fullName || 'User',
                    userAvatar: currentUserData.avatar || defaultAvatar,
                    mediaUrl,
                    mediaType,
                    caption,
                    timestamp: serverTimestamp(),
                    likes: []
                });

                postUploadModal.style.display = 'none';
                Toastify({ text: 'Post published!', backgroundColor: 'green' }).showToast();
                updateUploadButton();
            } catch (e) {
                playErrorSound();
                postUploadStatus.textContent = 'Error: ' + e.message;
            }
        };

        // ===== Comments =====
        async function loadComments(postId) {
            if (commentUnsubscribes.has(postId)) {
                commentUnsubscribes.get(postId)();
            }
            const commentsRef = collection(db, 'posts', postId, 'comments');
            const q = query(commentsRef, orderBy('timestamp', 'asc'));
            const unsubscribe = onSnapshot(q, (snap) => {
                const comments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderComments(postId, comments);
            }, (error) => {
                console.error('Comments listener error:', error);
            });
            commentUnsubscribes.set(postId, unsubscribe);
        }

        function renderComments(postId, comments) {
            const commentList = document.getElementById(`comments-${postId}`);
            if (!commentList) return;
            commentList.innerHTML = comments.map(c => {
                const time = c.timestamp ? formatTimeAgo(c.timestamp) : '';
                return `
                    <div class="comment-item">
                        <img src="${c.userAvatar || defaultAvatar}" class="comment-avatar" onerror="this.src='${defaultAvatar}'">
                        <div class="comment-content">
                            <div class="comment-author">${c.userName || 'User'}</div>
                            <div class="comment-text">${c.text}</div>
                            <div class="comment-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleComments = function(postId) {
            const section = document.getElementById(`comment-section-${postId}`);
            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                loadComments(postId);
            } else {
                section.style.display = 'none';
                if (commentUnsubscribes.has(postId)) {
                    commentUnsubscribes.get(postId)();
                    commentUnsubscribes.delete(postId);
                }
            }
        };

        window.postComment = async function(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            const commentsRef = collection(db, 'posts', postId, 'comments');
            await addDoc(commentsRef, {
                userId: currentUser.uid,
                userName: currentUserData.fullName || 'User',
                userAvatar: currentUserData.avatar || defaultAvatar,
                text,
                timestamp: serverTimestamp()
            });
            input.value = '';
        };

        // Setup IntersectionObserver for video autoplay
        function setupVideoObserver() {
            if (postVideosObserver) postVideosObserver.disconnect();
            postVideosObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target;
                    const overlay = video.closest('.post-media-container')?.querySelector('.video-overlay');
                    if (entry.isIntersecting) {
                        video.muted = true;
                        video.play().then(() => {
                            if (overlay) {
                                overlay.classList.add('fade-out');
                                setTimeout(() => {
                                    overlay.style.display = 'none';
                                }, 500);
                            }
                        }).catch(e => console.log('Autoplay prevented', e));
                    } else {
                        video.pause();
                        if (overlay) {
                            overlay.style.display = 'flex';
                            overlay.classList.remove('fade-out');
                        }
                    }
                });
            }, { threshold: 0.5 });
            document.querySelectorAll('.post-media.video').forEach(video => {
                postVideosObserver.observe(video);
            });
        }

        function loadPosts() {
            if (postsUnsubscribe) postsUnsubscribe();
            const q = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
            postsUnsubscribe = onSnapshot(q, async (snap) => {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;

                const deletePromises = [];
                snap.docs.forEach(docSnap => {
                    const post = docSnap.data();
                    if (post.timestamp && (now - post.timestamp.toDate()) > oneDay) {
                        deletePromises.push(deleteDoc(docSnap.ref));
                    }
                });
                await Promise.all(deletePromises);

                const freshSnap = await getDocs(q);
                const posts = freshSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts(posts);
                setTimeout(setupVideoObserver, 500);
            }, (error) => {
                console.error('Posts listener error:', error);
            });
        }

        function renderPosts(posts) {
            if (!postsFeed) return;
            if (posts.length === 0) {
                postsFeed.innerHTML = '<div class="notification-empty">No posts yet</div>';
                return;
            }
            postsFeed.innerHTML = posts.map(p => {
                const isLiked = p.likes?.includes(currentUser.uid);
                const likeCount = p.likes?.length || 0;
                const time = p.timestamp ? formatTimeAgo(p.timestamp) : '';
                const isCelebPost = p.userId && p.userId.startsWith('celeb_');
                const verifiedIcon = isCelebPost ? '<i class="fas fa-check-circle verified-badge"></i>' : '';
                
                let mediaHtml = '';
                if (p.mediaType === 'image') {
                    mediaHtml = `<img src="${p.mediaUrl}" class="post-media" loading="lazy">`;
                } else {
                    const videoUrl = p.mediaUrl.includes('cloudinary') ? 
                        p.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto/') : 
                        p.mediaUrl;
                    const posterUrl = p.mediaUrl.includes('cloudinary') ?
                        p.mediaUrl.replace('/upload/', '/upload/f_auto,q_auto,w_800/').replace(/\.[^/.]+$/, '.jpg') :
                        p.mediaUrl;
                    mediaHtml = `
                        <div class="post-media-container" onclick="this.querySelector('video').paused ? this.querySelector('video').play() : this.querySelector('video').pause()">
                            <video class="post-media video" src="${videoUrl}" poster="${posterUrl}" loop muted playsinline preload="none"></video>
                            <div class="video-overlay">
                                <i class="fas fa-play-circle"></i>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="post-card" data-post-id="${p.id}">
                        <div class="post-header">
                            <img src="${p.userAvatar}" class="post-avatar" onerror="this.src='${defaultAvatar}'">
                            <div class="post-info">
                                <div class="post-name">
                                    ${p.userName}
                                    ${verifiedIcon}
                                </div>
                                <div class="post-time">${time}</div>
                            </div>
                        </div>
                        ${mediaHtml}
                        ${p.caption ? `<div class="post-caption">${p.caption}</div>` : ''}
                        <div class="post-actions">
                            <div class="post-like ${isLiked ? 'liked' : ''}" onclick="toggleLike('${p.id}')">
                                <i class="fas fa-heart"></i>
                                <span>${likeCount}</span>
                            </div>
                            <div class="post-comment" onclick="toggleComments('${p.id}')">
                                <i class="fas fa-comment"></i>
                                <span>Comment</span>
                            </div>
                        </div>
                        <div id="comment-section-${p.id}" class="comment-section" style="display: none;">
                            <div id="comments-${p.id}" class="comment-list"></div>
                            <div class="comment-input-area">
                                <input type="text" id="comment-input-${p.id}" class="comment-input" placeholder="Write a comment...">
                                <button class="comment-send" onclick="postComment('${p.id}')"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleLike = async function(postId) {
            if (!currentUser) return;
            const postRef = doc(db, 'posts', postId);
            const postSnap = await getDoc(postRef);
            if (!postSnap.exists()) return;
            const likes = postSnap.data().likes || [];
            if (likes.includes(currentUser.uid)) {
                await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
            }
        };

        // ========== SEARCH ==========
        document.getElementById('searchCelebs')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#allCelebGrid .celeb-card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none';
            });
        });

        document.getElementById('searchUsers')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#userList .friend-card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        });

        // ========== ADMIN CHAT SUPPORT BUTTON ==========
        window.openAdminChat = async function() {
            if (!currentUser) return;
            if (adminUserData) {
                openUserChat(adminUserData.fullName, adminUserData.avatar, adminUserData.uid);
                return;
            }
            try {
                const q = query(collection(db, 'users'), where('email', '==', ADMIN_EMAIL));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    playErrorSound();
                    Toastify({ text: "Admin user not found. Please create an account with email " + ADMIN_EMAIL + " first.", backgroundColor: "#e74c3c" }).showToast();
                    return;
                }
                const adminDoc = querySnapshot.docs[0];
                adminUserData = {
                    uid: adminDoc.id,
                    ...adminDoc.data()
                };
                openUserChat(adminUserData.fullName, adminUserData.avatar, adminUserData.uid);
            } catch (error) {
                playErrorSound();
                Toastify({ text: "Error opening admin chat", backgroundColor: "#e74c3c" }).showToast();
            }
        };

        // ========== LOAD PRODUCTS FROM FIRESTORE ==========
        async function loadProducts() {
            const q = query(collection(db, 'products'));
            onSnapshot(q, (snap) => {
                const products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMarketplace(products);
            });
        }

        function renderMarketplace(products) {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            if (products.length === 0) {
                grid.innerHTML = '<div class="card">No products available yet.</div>';
                return;
            }
            grid.innerHTML = products.map(p => `
                <div class="product-card">
                    <div class="product-img"><i class="fas fa-${p.icon || 'box'}"></i></div>
                    <div class="product-info">
                        <div class="product-title">${p.name}</div>
                        <div class="product-price">$${p.price}</div>
                        <button class="btn-buy" onclick="openBuyModal('${p.name}', ${p.price})">Buy Now</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== CALL SYSTEM ==========
        let peerConnection = null;
        let localStream = null;
        let currentCallId = null;
        let incomingCallDoc = null;
        let unsubscribeCallListener = null;
        let unsubscribeOfferCandidates = null;
        let unsubscribeAnswerCandidates = null;

        const servers = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        function showCallModal() {
            document.getElementById("callModal").style.display = "flex";
        }

        function hideCallModal() {
            document.getElementById("callModal").style.display = "none";
        }

        function updateCallUI(status, showAcceptReject = false, showEnd = false, avatarUrl = null) {
            if (avatarUrl) {
                document.getElementById('callAvatarImg').src = avatarUrl;
            }
            document.getElementById('callStatus').innerText = status;
            document.getElementById('acceptCallBtn').style.display = showAcceptReject ? 'inline-block' : 'none';
            document.getElementById('rejectCallBtn').style.display = showAcceptReject ? 'inline-block' : 'none';
            document.getElementById('endCallBtn').style.display = showEnd ? 'inline-block' : 'none';
            
            if (status === 'In call') {
                document.getElementById('localVideo').style.display = 'block';
                document.getElementById('remoteVideo').style.display = 'block';
                document.getElementById('callAvatarContainer').style.display = 'none';
            } else {
                document.getElementById('localVideo').style.display = 'none';
                document.getElementById('remoteVideo').style.display = 'none';
                document.getElementById('callAvatarContainer').style.display = 'block';
            }
        }

        async function requestMedia(type) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: type === 'video',
                    audio: true
                });
                return stream;
            } catch (error) {
                playErrorSound();
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    Toastify({ text: "Camera/Microphone access denied. Please allow permissions.", backgroundColor: "#e74c3c" }).showToast();
                } else if (error.name === 'NotFoundError') {
                    Toastify({ text: "No camera or microphone found.", backgroundColor: "#e74c3c" }).showToast();
                } else if (error.name === 'NotReadableError') {
                    Toastify({ text: "Camera or microphone already in use by another app.", backgroundColor: "#e74c3c" }).showToast();
                } else {
                    Toastify({ text: "Could not access media: " + error.message, backgroundColor: "#e74c3c" }).showToast();
                }
                throw error;
            }
        }

        async function cleanupCall(deleteFromFirestore = true) {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (unsubscribeCallListener) {
                unsubscribeCallListener();
                unsubscribeCallListener = null;
            }
            if (unsubscribeOfferCandidates) {
                unsubscribeOfferCandidates();
                unsubscribeOfferCandidates = null;
            }
            if (unsubscribeAnswerCandidates) {
                unsubscribeAnswerCandidates();
                unsubscribeAnswerCandidates = null;
            }
            if (currentCallId && deleteFromFirestore) {
                try {
                    const offerCandidatesSnap = await getDocs(collection(db, 'calls', currentCallId, 'offerCandidates'));
                    const batch = writeBatch(db);
                    offerCandidatesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    const answerCandidatesSnap = await getDocs(collection(db, 'calls', currentCallId, 'answerCandidates'));
                    answerCandidatesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await deleteDoc(doc(db, 'calls', currentCallId));
                } catch (e) {
                    console.error("Error deleting call documents:", e);
                }
                currentCallId = null;
            }
            hideCallModal();
        }

        window.endCall = cleanupCall;

        async function startCall(type, receiverId, partnerName, partnerAvatar) {
            if (!currentUser) return;
            if (currentUserData.vipLevel < 4) {
                playErrorSound();
                Toastify({ text: "VIP 4 required for calls", backgroundColor: "#e74c3c" }).showToast();
                return;
            }

            try {
                localStream = await requestMedia(type);
            } catch {
                return;
            }

            peerConnection = new RTCPeerConnection(servers);
            peerConnection.ontrack = event => {
                document.getElementById("remoteVideo").srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            document.getElementById("localVideo").srcObject = localStream;

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            const callData = {
                callerId: currentUser.uid,
                receiverId: receiverId,
                type: type,
                status: 'calling',
                offer: JSON.stringify(offer),
                createdAt: serverTimestamp()
            };
            const callRef = await addDoc(collection(db, 'calls'), callData);
            currentCallId = callRef.id;

            unsubscribeCallListener = onSnapshot(doc(db, 'calls', currentCallId), async (snap) => {
                const data = snap.data();
                if (!data) return;
                if (data.answer && !peerConnection.currentRemoteDescription) {
                    const answer = new RTCSessionDescription(JSON.parse(data.answer));
                    await peerConnection.setRemoteDescription(answer);
                    updateCallUI('In call', false, true, partnerAvatar);
                }
                if (data.status === 'rejected' || data.status === 'ended') {
                    Toastify({ text: `Call ${data.status}`, backgroundColor: "#e74c3c" }).showToast();
                    cleanupCall(false);
                }
            });

            unsubscribeAnswerCandidates = onSnapshot(collection(db, 'calls', currentCallId, 'answerCandidates'), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    await addDoc(collection(db, 'calls', currentCallId, 'offerCandidates'), {
                        candidate: JSON.stringify(event.candidate)
                    });
                }
            };

            showCallModal();
            updateCallUI('Connecting...', false, true, partnerAvatar);
        }

        window.startCall = startCall;

        async function listenForIncomingCalls() {
            onSnapshot(query(
                collection(db, 'calls'),
                where('receiverId', '==', currentUser?.uid),
                where('status', '==', 'calling')
            ), async (snapshot) => {
                if (snapshot.empty) return;
                const callDoc = snapshot.docs[0];
                const data = callDoc.data();
                currentCallId = callDoc.id;
                incomingCallDoc = callDoc;

                const callerSnap = await getDoc(doc(db, 'users', data.callerId));
                const callerData = callerSnap.data();

                showCallModal();
                updateCallUI(`Incoming ${data.type} call from ${callerData?.fullName || 'User'}`, true, false, callerData?.avatar || defaultAvatar);

                document.getElementById('acceptCallBtn').onclick = () => acceptCall(callDoc, callerData);
                document.getElementById('rejectCallBtn').onclick = () => rejectCall(callDoc);
            });
        }

        async function acceptCall(callDoc, callerData) {
            try {
                localStream = await requestMedia(callDoc.data().type);
            } catch {
                return;
            }

            peerConnection = new RTCPeerConnection(servers);
            peerConnection.ontrack = event => {
                document.getElementById("remoteVideo").srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            document.getElementById("localVideo").srcObject = localStream;

            const offer = new RTCSessionDescription(JSON.parse(callDoc.data().offer));
            await peerConnection.setRemoteDescription(offer);

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await updateDoc(doc(db, 'calls', currentCallId), {
                answer: JSON.stringify(answer),
                status: 'accepted'
            });

            unsubscribeOfferCandidates = onSnapshot(collection(db, 'calls', currentCallId, 'offerCandidates'), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    await addDoc(collection(db, 'calls', currentCallId, 'answerCandidates'), {
                        candidate: JSON.stringify(event.candidate)
                    });
                }
            };

            unsubscribeCallListener = onSnapshot(doc(db, 'calls', currentCallId), (snap) => {
                const data = snap.data();
                if (data && data.status === 'ended') {
                    Toastify({ text: "Call ended", backgroundColor: "#e74c3c" }).showToast();
                    cleanupCall(false);
                }
            });

            updateCallUI('In call', false, true, callerData?.avatar);
        }

        async function rejectCall(callDoc) {
            await updateDoc(doc(db, 'calls', currentCallId), { status: 'rejected' });
            cleanupCall(true);
        }

        document.getElementById('endCallBtn').onclick = () => cleanupCall(true);

        // ========== PROFILE MUSIC CONTROL ==========
        window.toggleProfileMusic = function() {
            const musicUrl = 'https://arrogant-aquamarine-f5wub9nau7.edgeone.app/The_stranglers_-_Golden_brown_looped_slowed_to_perfection_._(SkySound.cc).mp3';
            
            if (!profileAudio) {
                profileAudio = new Audio(musicUrl);
                profileAudio.loop = true;
                profileAudio.volume = 0.5;
                
                profileAudio.addEventListener('play', () => {
                    isProfileMusicPlaying = true;
                    updateProfileMusicIcon(true);
                    Toastify({ text: "Music playing", backgroundColor: "#8e44ad" }).showToast();
                });
                profileAudio.addEventListener('pause', () => {
                    isProfileMusicPlaying = false;
                    updateProfileMusicIcon(false);
                    Toastify({ text: "Music paused", backgroundColor: "#8e44ad" }).showToast();
                });
                profileAudio.addEventListener('ended', () => {
                    isProfileMusicPlaying = false;
                    updateProfileMusicIcon(false);
                });
                profileAudio.addEventListener('error', (e) => {
                    console.error('Audio error:', e);
                    Toastify({ text: "Could not play music", backgroundColor: "#e74c3c" }).showToast();
                    updateProfileMusicIcon(false);
                });
            }
            
            if (isProfileMusicPlaying) {
                profileAudio.pause();
            } else {
                profileAudio.play().catch(e => {
                    console.error('Playback failed:', e);
                    Toastify({ text: "Click again to play music", backgroundColor: "#e74c3c" }).showToast();
                });
            }
        };

        function updateProfileMusicIcon(isPlaying) {
            const musicIcon = document.getElementById('profileMusicIcon');
            if (!musicIcon) return;
            if (isPlaying) {
                musicIcon.classList.add('playing');
                musicIcon.title = 'Pause music';
            } else {
                musicIcon.classList.remove('playing');
                musicIcon.title = 'Play music';
            }
        }

        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'giftStoreModal') {
                clearBlackhawkInterval();
            }
        };

        // ========== TRANSACTIONS ==========
        async function addTransaction(transaction) {
            if (!currentUser) return;
            await addDoc(collection(db, 'transactions', currentUser.uid, 'userTransactions'), {
                ...transaction,
                timestamp: serverTimestamp()
            });
        }

        function loadTransactions() {
            if (!currentUser) return;
            if (transactionsUnsubscribe) transactionsUnsubscribe();

            const q = query(
                collection(db, 'transactions', currentUser.uid, 'userTransactions'),
                orderBy('timestamp', 'desc')
            );

            transactionsUnsubscribe = onSnapshot(q, (snap) => {
                transactions = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTransactions();
            });
        }

        function renderTransactions() {
            const container = document.getElementById('transactionList');
            if (!container) return;
            if (transactions.length === 0) {
                container.innerHTML = '<div class="notification-empty">No transactions yet</div>';
                return;
            }
            container.innerHTML = transactions.map(t => {
                const amountClass = t.amount < 0 ? 'transaction-negative' : 'transaction-amount';
                const statusClass = t.status === 'pending' ? 'status-pending' : 
                                   t.status === 'completed' ? 'status-completed' : 'status-failed';
                const time = t.timestamp ? formatTimeAgo(t.timestamp) : '';
                return `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-type">${t.details || t.type}</div>
                            <div class="transaction-time">${time}</div>
                        </div>
                        <div style="text-align:right;">
                            <div class="${amountClass}">${t.amount < 0 ? '-' : '+'}$${Math.abs(t.amount).toFixed(2)}</div>
                            <span class="transaction-status ${statusClass}">${t.status}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== AVATAR UPLOAD ==========
        window.openAvatarModal = () => document.getElementById('avatarModal').style.display = 'flex';
        window.uploadAvatar = async () => {
            const file = document.getElementById('avatarFileInput').files[0];
            if (!file) {
                playErrorSound();
                return Toastify({ text: "Select an image" }).showToast();
            }

            const img = new Image();
            const objectUrl = URL.createObjectURL(file);
            img.onload = async function() {
                URL.revokeObjectURL(objectUrl);
                if (img.width < 500 || img.height < 500) {
                    playErrorSound();
                    document.getElementById('avatarUploadStatus').innerText = 'Image too small. Minimum 500x500 pixels.';
                    return;
                }

                const status = document.getElementById('avatarUploadStatus');
                status.innerText = 'Uploading...';
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                try {
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error?.message);
                    await updateDoc(doc(db, 'users', currentUser.uid), { avatar: data.secure_url });
                    currentUserData.avatar = data.secure_url;
                    document.getElementById('profileAvatar').src = data.secure_url;
                    document.getElementById('homeProfileAvatar').src = data.secure_url;
                    document.getElementById('avatarModal').style.display = 'none';
                    Toastify({ text: "Avatar updated" }).showToast();
                } catch (e) {
                    playErrorSound();
                    status.innerText = 'Error: ' + e.message;
                }
            };
            img.src = objectUrl;
        };

        window.navTo = (page, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');

            const giftBtn = document.getElementById('giftStoreFloat');
            giftBtn.style.display = page === 'home' ? 'flex' : 'none';

            const supportBtn = document.getElementById('supportChatFloat');
            supportBtn.style.display = page === 'profile' ? 'flex' : 'none';

            if (page === 'posts') {
                loadPosts();
            } else {
                if (postsUnsubscribe) {
                    postsUnsubscribe();
                    postsUnsubscribe = null;
                }
            }
        };

        // ========== AUTH STATE ==========
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const docSnap = await getDoc(doc(db, 'users', user.uid));
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                } else {
                    currentUserData = {
                        fullName: user.email.split('@')[0],
                        email: user.email,
                        balance: 0,
                        vipLevel: 1,
                        avatar: defaultAvatar,
                        wallpaper: 'static17',
                        uploadCount: 0,
                        lastUploadDate: '',
                        followers: [],
                        following: []
                    };
                    await setDoc(doc(db, 'users', user.uid), currentUserData);
                }
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                updateBalanceDisplay();
                document.getElementById('userVipLevel').innerText = currentUserData?.vipLevel ?? '1';
                document.getElementById('profileName').innerText = currentUserData?.fullName ?? 'User';
                document.getElementById('profileAvatar').src = currentUserData?.avatar ?? defaultAvatar;
                
                updateHomeProfile();

                loadWallpapers();
                await loadCelebrities();
                loadUsers();
                loadRecentChats();
                loadNotifications();
                loadProducts();
                loadTransactions();
                loadFollowStats();
                updateUploadButton();

                document.getElementById('bellIcon').addEventListener('click', toggleNotificationDropdown);

                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('adminCelebForm').style.display = 'block';
                } else {
                    document.getElementById('adminCelebForm').style.display = 'none';
                }

                listenForIncomingCalls();
                document.getElementById('supportChatFloat').style.display = 'none';
                
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
                if (profileAudio) {
                    profileAudio.pause();
                    isProfileMusicPlaying = false;
                    updateProfileMusicIcon(false);
                }
                clearBlackhawkInterval();
                if (wallpapersUnsubscribe) wallpapersUnsubscribe();
            }
        });
    </script>
</body>
</html>
